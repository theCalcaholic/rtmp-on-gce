#cloud-config

  
write_files:
  - path: /etc/systemd/system/rtmp-hls.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Start the rtmp authentication server

      [Service]
      ExecStart=/usr/bin/docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc/rtmp-hls-server/:/etc/rtmp-hls-server/ -w /etc/rtmp-hls-server/ docker/compose:latest up
      ExecStop=/usr/bin/docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc/rtmp-hls-server/:/etc/rtmp-hls-server/ -w /etc/rtmp-hls-server/ docker/compose:latest down
  - path: /etc/rtmp-hls-server/nginx_no_ssl.conf
    permissions: '0660'
    encoding: b64
    content: CnVzZXIgcm9vdDsKd29ya2VyX3Byb2Nlc3NlcyAgYXV0bzsKd29ya2VyX3JsaW1pdF9ub2ZpbGUgMTAwMDAwOwojZXJyb3JfbG9nICBsb2dzL2Vycm9yLmxvZzsKCmV2ZW50cyB7CiAgd29ya2VyX2Nvbm5lY3Rpb25zICA0MDk2OwogICNlcG9sbDsKfQoKIyBSVE1QIGNvbmZpZ3VyYXRpb24KcnRtcCB7CiAgc2VydmVyIHsKICAgIGxpc3RlbiAxOTM1OyAjIExpc3RlbiBvbiBzdGFuZGFyZCBSVE1QIHBvcnQKICAgIGNodW5rX3NpemUgNDA5NjsgCiAgICBwaW5nIDMwczsKICAgIG5vdGlmeV9tZXRob2QgZ2V0OwoKICAgICMgVGhpcyBhcHBsaWNhdGlvbiBpcyB0byBhY2NlcHQgaW5jb21pbmcgc3RyZWFtCiAgICBhcHBsaWNhdGlvbiBsaXZlIHsKICAgICAgbGl2ZSBvbjsgIyBBbGxvd3MgbGl2ZSBpbnB1dAogICAgICByZWNvcmQgb2ZmOwogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIG9uX3B1Ymxpc2ggaHR0cDovL3NpbXBsZS1hdXRoL3B1Ymxpc2g7CgogICAgICAjIGZvciBlYWNoIHJlY2VpdmVkIHN0cmVhbSwgdHJhbnNjb2RlIGZvciBhZGFwdGl2ZSBzdHJlYW1pbmcKICAgICAgIyBUaGlzIHNpbmdsZSBmZm1wZWcgY29tbWFuZCB0YWtlcyB0aGUgaW5wdXQgYW5kIHRyYW5zZm9ybXMKICAgICAgIyB0aGUgc291cmNlIGludG8gNCBkaWZmZXJlbnQgc3RyZWFtcyB3aXRoIGRpZmZlcmVudCBiaXRyYXRlcwogICAgICAjIGFuZCBxdWFsaXRpZXMuICMgdGhlc2Ugc2V0dGluZ3MgcmVzcGVjdCB0aGUgYXNwZWN0IHJhdGlvLgogICAgICBleGVjX3B1c2ggIC91c3IvbG9jYWwvYmluL2ZmbXBlZyAtaSBydG1wOi8vbG9jYWxob3N0OjE5MzUvJGFwcC8kbmFtZSAtYXN5bmMgMSAtdnN5bmMgLTEKICAgICAgICAgICAgICAgICAgLWM6diBsaWJ4MjY0IC12cHJvZmlsZSBtYWluIC1jOmEgYWFjIC1iOnYgMjU2ayAgLWI6YSA2NGsgIC12ZiAic2NhbGU9NDgwOnRydW5jKG93L2EvMikqMiIgIC10dW5lIHplcm9sYXRlbmN5IC1wcmVzZXQgc3VwZXJmYXN0IC1jcmYgMjMgLWYgZmx2IHJ0bXA6Ly8xMjcuMC4wLjE6MTkzNS9zaG93LyRuYW1lX2xvdwogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLXZwcm9maWxlIG1haW4gLWM6YSBhYWMgLWI6diA3NjhrICAtYjphIDEyOGsgLXZmICJzY2FsZT03MjA6dHJ1bmMob3cvYS8yKSoyIiAgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovLzEyNy4wLjAuMToxOTM1L3Nob3cvJG5hbWVfbWlkCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDEwMjRrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTk2MDp0cnVuYyhvdy9hLzIpKjIiICAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oaWdoCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDE5MjBrIC1iOmEgMTkyayAtdmYgInNjYWxlPTEyODA6dHJ1bmMob3cvYS8yKSoyIiAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oZDcyMAogICAgICAgICAgICAgICAgICAtYyBjb3B5IC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9zcmM7CiAgICAgIAogICAgICAjcHVibGlzaF9ub3RpZnkgb247CiAgICAgICMgcmVjb3JkX3BhdGggL21udC9yZWNvcmQvOwogICAgICAjIHJlY29yZF91bmlxdWUgb247CiAgICAgICMgcmVjb3JkX2ludGVydmFsIDMwczsKICAgICAgI2V4ZWNfcmVjb3JkX2RvbmUgZmZtcGVnIC15IC1pICRwYXRoIC1hY29kZWMgbGlibXAzbGFtZSAtYXIgNDQxMDAgLWFjIDEgLXZjb2RlYyBsaWJ4MjY0ICRkaXJuYW1lLyRiYXNlbmFtZS5tcDQ7CiAgICAgICNleGVjX3B1Ymxpc2hfZG9uZSAvc2NyaXB0cy9wcm9jZXNzX3JlY29yZGVkLnNoICRkaXJuYW1lICRiYXNlbmFtZTsKICAgICAgI2V4ZWNfcHVibGlzaCAvYmluL2VjaG8gImxpdmUgLyBleGVjX3B1Ymxpc2giID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgICAjIGV4ZWNfcHVibGlzaF9kb25lIGJhc2ggLWMgL3NjcmlwdHMvcHJvY2Vzc19yZWNvcmRlZC5zaCAke25hbWV9OwoKICAgIH0KCiAgICAjIFRoaXMgaXMgdGhlIEhMUyBhcHBsaWNhdGlvbgogICAgYXBwbGljYXRpb24gc2hvdyB7CiAgICAgIGxpdmUgb247ICMgQWxsb3dzIGxpdmUgaW5wdXQgZnJvbSBhYm92ZSBhcHBsaWNhdGlvbgogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIGFsbG93IHB1Ymxpc2ggMTI3LjAuMC4xOwogICAgICBkZW55IHB1Ymxpc2ggYWxsOwogICAgICBkZW55IHBsYXkgYWxsOyAjIGRpc2FibGUgY29uc3VtaW5nIHRoZSBzdHJlYW0gZnJvbSBuZ2lueCBhcyBydG1wCiAgICAgIAogICAgICBobHMgb247ICMgRW5hYmxlIEhUVFAgTGl2ZSBTdHJlYW1pbmcKICAgICAgaGxzX2ZyYWdtZW50IDM7CiAgICAgIGhsc19wbGF5bGlzdF9sZW5ndGggNjA7CiAgICAgIGhsc19jbGVhbnVwIG9uOwogICAgICAjaGxzX2NvbnRpbnVvdXMgb247CiAgICAgIGhsc19wYXRoIC9tbnQvaGxzLzsgICMgaGxzIGZyYWdtZW50cyBwYXRoCiAgICAgICMgSW5zdHJ1Y3QgY2xpZW50cyB0byBhZGp1c3QgcmVzb2x1dGlvbiBhY2NvcmRpbmcgdG8gYmFuZHdpZHRoCiAgICAgIGhsc192YXJpYW50IF9zcmMgQkFORFdJRFRIPTQwOTYwMDA7ICMgU291cmNlIGJpdHJhdGUsIHNvdXJjZSByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9oZDcyMCBCQU5EV0lEVEg9MjA0ODAwMDsgIyBIaWdoIGJpdHJhdGUsIEhEIDcyMHAgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfaGlnaCBCQU5EV0lEVEg9MTE1MjAwMDsgIyBIaWdoIGJpdHJhdGUsIGhpZ2hlci10aGFuLVNEIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX21pZCBCQU5EV0lEVEg9NDQ4MDAwOyAjIE1lZGl1bSBiaXRyYXRlLCBTRCByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9sb3cgQkFORFdJRFRIPTI4ODAwMDsgIyBMb3cgYml0cmF0ZSwgc3ViLVNEIHJlc29sdXRpb24KICAgICAgCiAgICAgICMgTVBFRy1EQVNICiAgICAgIGRhc2ggb247CiAgICAgIGRhc2hfcGF0aCAvbW50L2Rhc2gvOyAgIyBkYXNoIGZyYWdtZW50cyBwYXRoCiAgICAgIGRhc2hfZnJhZ21lbnQgMzsKICAgICAgZGFzaF9wbGF5bGlzdF9sZW5ndGggMzA7CQkJCiAgICAgIGV4ZWNfcHVibGlzaCAvYmluL2VjaG8gInNob3cgLyBleGVjX3B1Ymxpc2giID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgICBleGVjX3B1Ymxpc2hfZG9uZSAvYmluL2VjaG8gInNob3cgLyBleGVjX3B1Ymxpc2hfZG9uZSIgPj4gL3Zhci9sb2cvc2NyaXB0cy5sb2c7CiAgICB9CiAgfQp9CgoKaHR0cCB7CiAgc2VuZGZpbGUgb2ZmOwogIHRjcF9ub3B1c2ggb247CiAgZGlyZWN0aW8gNTEyOwogICMgYWlvIG9uOwogIG9wZW5fZmlsZV9jYWNoZSBtYXg9MjAwMDAwIGluYWN0aXZlPTIwczsKICBvcGVuX2ZpbGVfY2FjaGVfdmFsaWQgMzBzOwogIG9wZW5fZmlsZV9jYWNoZV9taW5fdXNlcyAyOwogIG9wZW5fZmlsZV9jYWNoZV9lcnJvcnMgb247CiAgZ3ppcCBvbjsKICBnemlwX21pbl9sZW5ndGggMTAyNDA7CiAgZ3ppcF9jb21wX2xldmVsIDE7CiAgZ3ppcF92YXJ5IG9uOwogIGd6aXBfZGlzYWJsZSBtc2llNjsKICBnemlwX3Byb3hpZWQgZXhwaXJlZCBuby1jYWNoZSBuby1zdG9yZSBwcml2YXRlIGF1dGg7CiAgZ3ppcF90eXBlcwogICAgdGV4dC9jc3MKICAgIHRleHQvamF2YXNjcmlwdAogICAgdGV4dC94bWwKICAgIHRleHQvcGxhaW4KICAgIHRleHQveC1jb21wb25lbnQKICAgIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQKICAgIGFwcGxpY2F0aW9uL3gtamF2YXNjcmlwdAogICAgYXBwbGljYXRpb24vanNvbgogICAgYXBwbGljYXRpb24veG1sCiAgICBhcHBsaWNhdGlvbi9yc3MreG1sCiAgICBhcHBsaWNhdGlvbi9hdG9tK3htbAogICAgZm9udC90cnVldHlwZQogICAgZm9udC9vcGVudHlwZQogICAgYXBwbGljYXRpb24vdm5kLm1zLWZvbnRvYmplY3QKICAgIGltYWdlL3N2Zyt4bWw7CiAgI2FjY2Vzc19sb2cgbG9ncy9hY2Nlc3MubG9nIG1haW47CiAgCiAgIyBIVFRQIHNlcnZlciByZXF1aXJlZCB0byBzZXJ2ZSB0aGUgcGxheWVyIGFuZCBITFMgZnJhZ21lbnRzCiAgc2VydmVyIHsKICAgIAogICAgbGlzdGVuIDgwOwogICAgCgogICAgbG9jYXRpb24gLyB7CiAgICAgIGF1dGhfYmFzaWMgIkF1dGhlbnRpY2F0aW9uICh1c2VyPXZpZXdlcikiOwogICAgICBhdXRoX2Jhc2ljX3VzZXJfZmlsZSAvLmh0cGFzc3dkOwoKICAgICAgcm9vdCAvZXRjL25naW54L2h0bWw7CiAgICAgIGluZGV4IGluZGV4Lmh0bWwgaW5kZXguaHRtOwogICAgfQoKICAgIGxvY2F0aW9uIC9tYW5pZmVzdC53ZWJtYW5pZmVzdCB7CiAgICAgIGF1dGhfYmFzaWMgbm87CiAgICAgIHJvb3QgL2V0Yy9uZ2lueC9odG1sOwogICAgICBpbmRleCBpbmRleC5odG1sIGluZGV4Lmh0bTsKICAgIH0KICAgICMgU2VydmUgSExTIGZyYWdtZW50cwogICAgbG9jYXRpb24gL2hscyB7CiAgICAgIHR5cGVzIHsKICAgICAgICBhcHBsaWNhdGlvbi92bmQuYXBwbGUubXBlZ3VybCBtM3U4OwogICAgICAgIHZpZGVvL21wMnQgdHM7CiAgICAgIH0KICAgICAgCiAgICAgIHJvb3QgL21udDsKCiAgICAgIGFkZF9oZWFkZXIgQ2FjaGUtQ29udHJvbCBuby1jYWNoZTsgIyBEaXNhYmxlIGNhY2hlCiAgICAgIAogICAgICAjIENPUlMgc2V0dXAKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKicgYWx3YXlzOwogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1FeHBvc2UtSGVhZGVycycgJ0NvbnRlbnQtTGVuZ3RoJzsKICAgICAgCiAgICAgICMgYWxsb3cgQ09SUyBwcmVmbGlnaHQgcmVxdWVzdHMKICAgICAgaWYgKCRyZXF1ZXN0X21ldGhvZCA9ICdPUFRJT05TJykgewogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonOwogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLU1heC1BZ2UnIDE3MjgwMDA7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1UeXBlJyAndGV4dC9wbGFpbiBjaGFyc2V0PVVURi04JzsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LUxlbmd0aCcgMDsKICAgICAgICByZXR1cm4gMjA0OwogICAgICB9CiAgICB9CiAgICAKICAgICMgU2VydmUgREFTSCBmcmFnbWVudHMKICAgIGxvY2F0aW9uIC9kYXNoIHsKICAgICAgdHlwZXMgewogICAgICAgIGFwcGxpY2F0aW9uL2Rhc2greG1sIG1wZDsKICAgICAgICB2aWRlby9tcDQgbXA0OwogICAgICB9CgogICAgICByb290IC9tbnQ7CiAgICAgIAogICAgICBhZGRfaGVhZGVyIENhY2hlLUNvbnRyb2wgbm8tY2FjaGU7ICMgRGlzYWJsZSBjYWNoZQoKCiAgICAgICMgQ09SUyBzZXR1cAogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJyBhbHdheXM7CiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUV4cG9zZS1IZWFkZXJzJyAnQ29udGVudC1MZW5ndGgnOwoKICAgICAgIyBBbGxvdyBDT1JTIHByZWZsaWdodCByZXF1ZXN0cwogICAgICBpZiAoJHJlcXVlc3RfbWV0aG9kID0gJ09QVElPTlMnKSB7CiAgICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKic7CiAgICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtTWF4LUFnZScgMTcyODAwMDsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LVR5cGUnICd0ZXh0L3BsYWluIGNoYXJzZXQ9VVRGLTgnOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtTGVuZ3RoJyAwOwogICAgICAgIHJldHVybiAyMDQ7CiAgICAgIH0KICAgIH0JCQogICAgCiAgICAjIFRoaXMgVVJMIHByb3ZpZGVzIFJUTVAgc3RhdGlzdGljcyBpbiBYTUwKICAgIGxvY2F0aW9uIC9zdGF0IHsKICAgICAgcnRtcF9zdGF0IGFsbDsKICAgICAgcnRtcF9zdGF0X3N0eWxlc2hlZXQgc3RhdC54c2w7ICMgVXNlIHN0YXQueHNsIHN0eWxlc2hlZXQgCiAgICB9CgogICAgbG9jYXRpb24gL3N0YXQueHNsIHsKICAgICAgIyBYTUwgc3R5bGVzaGVldCB0byB2aWV3IFJUTVAgc3RhdHMuCiAgICAgIHJvb3QgL3Vzci9sb2NhbC9uZ2lueC9odG1sOwogICAgfQoKICB9Cn0K
  - path: /etc/rtmp-hls-server/nginx_ssl.conf
    permissions: '0660'
    encoding: b64
    content: CnVzZXIgcm9vdDsKd29ya2VyX3Byb2Nlc3NlcyAgYXV0bzsKd29ya2VyX3JsaW1pdF9ub2ZpbGUgMTAwMDAwOwojZXJyb3JfbG9nICBsb2dzL2Vycm9yLmxvZzsKCmV2ZW50cyB7CiAgd29ya2VyX2Nvbm5lY3Rpb25zICA0MDk2OwogICNlcG9sbDsKfQoKIyBSVE1QIGNvbmZpZ3VyYXRpb24KcnRtcCB7CiAgc2VydmVyIHsKICAgIGxpc3RlbiAxOTM1OyAjIExpc3RlbiBvbiBzdGFuZGFyZCBSVE1QIHBvcnQKICAgIGNodW5rX3NpemUgNDA5NjsgCiAgICBwaW5nIDMwczsKICAgIG5vdGlmeV9tZXRob2QgZ2V0OwoKICAgICMgVGhpcyBhcHBsaWNhdGlvbiBpcyB0byBhY2NlcHQgaW5jb21pbmcgc3RyZWFtCiAgICBhcHBsaWNhdGlvbiBsaXZlIHsKICAgICAgbGl2ZSBvbjsgIyBBbGxvd3MgbGl2ZSBpbnB1dAogICAgICByZWNvcmQgb2ZmOwogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIG9uX3B1Ymxpc2ggaHR0cDovL3NpbXBsZS1hdXRoL3B1Ymxpc2g7CgogICAgICAjIGZvciBlYWNoIHJlY2VpdmVkIHN0cmVhbSwgdHJhbnNjb2RlIGZvciBhZGFwdGl2ZSBzdHJlYW1pbmcKICAgICAgIyBUaGlzIHNpbmdsZSBmZm1wZWcgY29tbWFuZCB0YWtlcyB0aGUgaW5wdXQgYW5kIHRyYW5zZm9ybXMKICAgICAgIyB0aGUgc291cmNlIGludG8gNCBkaWZmZXJlbnQgc3RyZWFtcyB3aXRoIGRpZmZlcmVudCBiaXRyYXRlcwogICAgICAjIGFuZCBxdWFsaXRpZXMuICMgdGhlc2Ugc2V0dGluZ3MgcmVzcGVjdCB0aGUgYXNwZWN0IHJhdGlvLgogICAgICBleGVjX3B1c2ggIC91c3IvbG9jYWwvYmluL2ZmbXBlZyAtaSBydG1wOi8vbG9jYWxob3N0OjE5MzUvJGFwcC8kbmFtZSAtYXN5bmMgMSAtdnN5bmMgLTEKICAgICAgICAgICAgICAgICAgLWM6diBsaWJ4MjY0IC12cHJvZmlsZSBtYWluIC1jOmEgYWFjIC1iOnYgMjU2ayAgLWI6YSA2NGsgIC12ZiAic2NhbGU9NDgwOnRydW5jKG93L2EvMikqMiIgIC10dW5lIHplcm9sYXRlbmN5IC1wcmVzZXQgc3VwZXJmYXN0IC1jcmYgMjMgLWYgZmx2IHJ0bXA6Ly8xMjcuMC4wLjE6MTkzNS9zaG93LyRuYW1lX2xvdwogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLXZwcm9maWxlIG1haW4gLWM6YSBhYWMgLWI6diA3NjhrICAtYjphIDEyOGsgLXZmICJzY2FsZT03MjA6dHJ1bmMob3cvYS8yKSoyIiAgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovLzEyNy4wLjAuMToxOTM1L3Nob3cvJG5hbWVfbWlkCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDEwMjRrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTk2MDp0cnVuYyhvdy9hLzIpKjIiICAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oaWdoCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDE5MjBrIC1iOmEgMTkyayAtdmYgInNjYWxlPTEyODA6dHJ1bmMob3cvYS8yKSoyIiAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oZDcyMAogICAgICAgICAgICAgICAgICAtYyBjb3B5IC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9zcmM7CiAgICAgIAogICAgICAjcHVibGlzaF9ub3RpZnkgb247CiAgICAgICMgcmVjb3JkX3BhdGggL21udC9yZWNvcmQvOwogICAgICAjIHJlY29yZF91bmlxdWUgb247CiAgICAgICMgcmVjb3JkX2ludGVydmFsIDMwczsKICAgICAgI2V4ZWNfcmVjb3JkX2RvbmUgZmZtcGVnIC15IC1pICRwYXRoIC1hY29kZWMgbGlibXAzbGFtZSAtYXIgNDQxMDAgLWFjIDEgLXZjb2RlYyBsaWJ4MjY0ICRkaXJuYW1lLyRiYXNlbmFtZS5tcDQ7CiAgICAgICNleGVjX3B1Ymxpc2hfZG9uZSAvc2NyaXB0cy9wcm9jZXNzX3JlY29yZGVkLnNoICRkaXJuYW1lICRiYXNlbmFtZTsKICAgICAgI2V4ZWNfcHVibGlzaCAvYmluL2VjaG8gImxpdmUgLyBleGVjX3B1Ymxpc2giID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgICAjIGV4ZWNfcHVibGlzaF9kb25lIGJhc2ggLWMgL3NjcmlwdHMvcHJvY2Vzc19yZWNvcmRlZC5zaCAke25hbWV9OwoKICAgIH0KCiAgICAjIFRoaXMgaXMgdGhlIEhMUyBhcHBsaWNhdGlvbgogICAgYXBwbGljYXRpb24gc2hvdyB7CiAgICAgIGxpdmUgb247ICMgQWxsb3dzIGxpdmUgaW5wdXQgZnJvbSBhYm92ZSBhcHBsaWNhdGlvbgogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIGFsbG93IHB1Ymxpc2ggMTI3LjAuMC4xOwogICAgICBkZW55IHB1Ymxpc2ggYWxsOwogICAgICBkZW55IHBsYXkgYWxsOyAjIGRpc2FibGUgY29uc3VtaW5nIHRoZSBzdHJlYW0gZnJvbSBuZ2lueCBhcyBydG1wCiAgICAgIAogICAgICBobHMgb247ICMgRW5hYmxlIEhUVFAgTGl2ZSBTdHJlYW1pbmcKICAgICAgaGxzX2ZyYWdtZW50IDM7CiAgICAgIGhsc19wbGF5bGlzdF9sZW5ndGggNjA7CiAgICAgIGhsc19jbGVhbnVwIG9uOwogICAgICAjaGxzX2NvbnRpbnVvdXMgb247CiAgICAgIGhsc19wYXRoIC9tbnQvaGxzLzsgICMgaGxzIGZyYWdtZW50cyBwYXRoCiAgICAgICMgSW5zdHJ1Y3QgY2xpZW50cyB0byBhZGp1c3QgcmVzb2x1dGlvbiBhY2NvcmRpbmcgdG8gYmFuZHdpZHRoCiAgICAgIGhsc192YXJpYW50IF9zcmMgQkFORFdJRFRIPTQwOTYwMDA7ICMgU291cmNlIGJpdHJhdGUsIHNvdXJjZSByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9oZDcyMCBCQU5EV0lEVEg9MjA0ODAwMDsgIyBIaWdoIGJpdHJhdGUsIEhEIDcyMHAgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfaGlnaCBCQU5EV0lEVEg9MTE1MjAwMDsgIyBIaWdoIGJpdHJhdGUsIGhpZ2hlci10aGFuLVNEIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX21pZCBCQU5EV0lEVEg9NDQ4MDAwOyAjIE1lZGl1bSBiaXRyYXRlLCBTRCByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9sb3cgQkFORFdJRFRIPTI4ODAwMDsgIyBMb3cgYml0cmF0ZSwgc3ViLVNEIHJlc29sdXRpb24KICAgICAgCiAgICAgICMgTVBFRy1EQVNICiAgICAgIGRhc2ggb247CiAgICAgIGRhc2hfcGF0aCAvbW50L2Rhc2gvOyAgIyBkYXNoIGZyYWdtZW50cyBwYXRoCiAgICAgIGRhc2hfZnJhZ21lbnQgMzsKICAgICAgZGFzaF9wbGF5bGlzdF9sZW5ndGggMzA7CQkJCiAgICAgIGV4ZWNfcHVibGlzaCAvYmluL2VjaG8gInNob3cgLyBleGVjX3B1Ymxpc2giID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgICBleGVjX3B1Ymxpc2hfZG9uZSAvYmluL2VjaG8gInNob3cgLyBleGVjX3B1Ymxpc2hfZG9uZSIgPj4gL3Zhci9sb2cvc2NyaXB0cy5sb2c7CiAgICB9CiAgfQp9CgoKaHR0cCB7CiAgc2VuZGZpbGUgb2ZmOwogIHRjcF9ub3B1c2ggb247CiAgZGlyZWN0aW8gNTEyOwogICMgYWlvIG9uOwogIG9wZW5fZmlsZV9jYWNoZSBtYXg9MjAwMDAwIGluYWN0aXZlPTIwczsKICBvcGVuX2ZpbGVfY2FjaGVfdmFsaWQgMzBzOwogIG9wZW5fZmlsZV9jYWNoZV9taW5fdXNlcyAyOwogIG9wZW5fZmlsZV9jYWNoZV9lcnJvcnMgb247CiAgZ3ppcCBvbjsKICBnemlwX21pbl9sZW5ndGggMTAyNDA7CiAgZ3ppcF9jb21wX2xldmVsIDE7CiAgZ3ppcF92YXJ5IG9uOwogIGd6aXBfZGlzYWJsZSBtc2llNjsKICBnemlwX3Byb3hpZWQgZXhwaXJlZCBuby1jYWNoZSBuby1zdG9yZSBwcml2YXRlIGF1dGg7CiAgZ3ppcF90eXBlcwogICAgdGV4dC9jc3MKICAgIHRleHQvamF2YXNjcmlwdAogICAgdGV4dC94bWwKICAgIHRleHQvcGxhaW4KICAgIHRleHQveC1jb21wb25lbnQKICAgIGFwcGxpY2F0aW9uL2phdmFzY3JpcHQKICAgIGFwcGxpY2F0aW9uL3gtamF2YXNjcmlwdAogICAgYXBwbGljYXRpb24vanNvbgogICAgYXBwbGljYXRpb24veG1sCiAgICBhcHBsaWNhdGlvbi9yc3MreG1sCiAgICBhcHBsaWNhdGlvbi9hdG9tK3htbAogICAgZm9udC90cnVldHlwZQogICAgZm9udC9vcGVudHlwZQogICAgYXBwbGljYXRpb24vdm5kLm1zLWZvbnRvYmplY3QKICAgIGltYWdlL3N2Zyt4bWw7CiAgI2FjY2Vzc19sb2cgbG9ncy9hY2Nlc3MubG9nIG1haW47CiAgCiAgIyBIVFRQIHNlcnZlciByZXF1aXJlZCB0byBzZXJ2ZSB0aGUgcGxheWVyIGFuZCBITFMgZnJhZ21lbnRzCiAgc2VydmVyIHsKICAgIAogICAgbGlzdGVuIDQ0MzsKICAgIAogICAgc2VydmVyX25hbWUgW1tTRVJWRVJfTkFNRV1dOwogICAgc3NsIG9uOwogICAgc3NsX2NlcnRpZmljYXRlIC9tbnQvbGV0c2VuY3J5cHQvbGl2ZS9bW1NFUlZFUl9OQU1FXV0vZnVsbGNoYWluLnBlbTsKICAgIHNzbF9jZXJ0aWZpY2F0ZV9rZXkgL21udC9sZXRzZW5jcnlwdC9saXZlL1tbU0VSVkVSX05BTUVdXS9wcml2a2V5LnBlbTsKICAgIAoKICAgIGxvY2F0aW9uIC8gewogICAgICBhdXRoX2Jhc2ljICJBdXRoZW50aWNhdGlvbiAodXNlcj12aWV3ZXIpIjsKICAgICAgYXV0aF9iYXNpY191c2VyX2ZpbGUgLy5odHBhc3N3ZDsKCiAgICAgIHJvb3QgL2V0Yy9uZ2lueC9odG1sOwogICAgICBpbmRleCBpbmRleC5odG1sIGluZGV4Lmh0bTsKICAgIH0KCiAgICBsb2NhdGlvbiAvbWFuaWZlc3Qud2VibWFuaWZlc3QgewogICAgICBhdXRoX2Jhc2ljIG5vOwogICAgICByb290IC9ldGMvbmdpbngvaHRtbDsKICAgICAgaW5kZXggaW5kZXguaHRtbCBpbmRleC5odG07CiAgICB9CiAgICAjIFNlcnZlIEhMUyBmcmFnbWVudHMKICAgIGxvY2F0aW9uIC9obHMgewogICAgICB0eXBlcyB7CiAgICAgICAgYXBwbGljYXRpb24vdm5kLmFwcGxlLm1wZWd1cmwgbTN1ODsKICAgICAgICB2aWRlby9tcDJ0IHRzOwogICAgICB9CiAgICAgIAogICAgICByb290IC9tbnQ7CgogICAgICBhZGRfaGVhZGVyIENhY2hlLUNvbnRyb2wgbm8tY2FjaGU7ICMgRGlzYWJsZSBjYWNoZQogICAgICAKICAgICAgIyBDT1JTIHNldHVwCiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonIGFsd2F5czsKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtRXhwb3NlLUhlYWRlcnMnICdDb250ZW50LUxlbmd0aCc7CiAgICAgIAogICAgICAjIGFsbG93IENPUlMgcHJlZmxpZ2h0IHJlcXVlc3RzCiAgICAgIGlmICgkcmVxdWVzdF9tZXRob2QgPSAnT1BUSU9OUycpIHsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJzsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1NYXgtQWdlJyAxNzI4MDAwOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtVHlwZScgJ3RleHQvcGxhaW4gY2hhcnNldD1VVEYtOCc7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1MZW5ndGgnIDA7CiAgICAgICAgcmV0dXJuIDIwNDsKICAgICAgfQogICAgfQogICAgCiAgICAjIFNlcnZlIERBU0ggZnJhZ21lbnRzCiAgICBsb2NhdGlvbiAvZGFzaCB7CiAgICAgIHR5cGVzIHsKICAgICAgICBhcHBsaWNhdGlvbi9kYXNoK3htbCBtcGQ7CiAgICAgICAgdmlkZW8vbXA0IG1wNDsKICAgICAgfQoKICAgICAgcm9vdCAvbW50OwogICAgICAKICAgICAgYWRkX2hlYWRlciBDYWNoZS1Db250cm9sIG5vLWNhY2hlOyAjIERpc2FibGUgY2FjaGUKCgogICAgICAjIENPUlMgc2V0dXAKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKicgYWx3YXlzOwogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1FeHBvc2UtSGVhZGVycycgJ0NvbnRlbnQtTGVuZ3RoJzsKCiAgICAgICMgQWxsb3cgQ09SUyBwcmVmbGlnaHQgcmVxdWVzdHMKICAgICAgaWYgKCRyZXF1ZXN0X21ldGhvZCA9ICdPUFRJT05TJykgewogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonOwogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLU1heC1BZ2UnIDE3MjgwMDA7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1UeXBlJyAndGV4dC9wbGFpbiBjaGFyc2V0PVVURi04JzsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LUxlbmd0aCcgMDsKICAgICAgICByZXR1cm4gMjA0OwogICAgICB9CiAgICB9CQkKICAgIAogICAgIyBUaGlzIFVSTCBwcm92aWRlcyBSVE1QIHN0YXRpc3RpY3MgaW4gWE1MCiAgICBsb2NhdGlvbiAvc3RhdCB7CiAgICAgIHJ0bXBfc3RhdCBhbGw7CiAgICAgIHJ0bXBfc3RhdF9zdHlsZXNoZWV0IHN0YXQueHNsOyAjIFVzZSBzdGF0LnhzbCBzdHlsZXNoZWV0IAogICAgfQoKICAgIGxvY2F0aW9uIC9zdGF0LnhzbCB7CiAgICAgICMgWE1MIHN0eWxlc2hlZXQgdG8gdmlldyBSVE1QIHN0YXRzLgogICAgICByb290IC91c3IvbG9jYWwvbmdpbngvaHRtbDsKICAgIH0KCiAgfQp9Cg==
  - path: /etc/rtmp-hls-server/docker-compose.yml
    permissions: '0660'
    encoding: b64
    content: CnZlcnNpb246ICczLjInCnNlcnZpY2VzOgogIHNpbXBsZS1hdXRoOgogICAgaW1hZ2U6IHRoZWNhbGNhaG9saWMvc2ltcGxlLWF1dGgKICAgIHZvbHVtZXM6CiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL2F1dGhfY29uZmlnOi9ldGMvYXV0aF9jb25maWciCiAgICByZXN0YXJ0OiB1bmxlc3Mtc3RvcHBlZAogIHJ0bXAtaGxzOgogICAgaW1hZ2U6IGFscXV0YW1pL3J0bXAtaGxzOmxhdGVzdC1hbHBpbmUKICAgIHBvcnRzOgogICAgICAtICI4MDo4MCIKICAgICAgLSAiNDQzOjQ0MyIKICAgICAgLSAiMTkzNToxOTM1IgogICAgZGVwZW5kc19vbjoKICAgICAgLSBzaW1wbGUtYXV0aAogICAgcmVzdGFydDogdW5sZXNzLXN0b3BwZWQKICAgIHZvbHVtZXM6CiAgICAgIC0gdHlwZTogdm9sdW1lCiAgICAgICAgc291cmNlOiBsZXRzZW5jcnlwdAogICAgICAgIHRhcmdldDogL2V0Yy9sZXRzZW5jcnlwdAogICAgICAgIHJlYWRfb25seTogdHJ1ZQogICAgICAtICIvZXRjL3J0bXAtaGxzLXNlcnZlci9uZ2lueC5jb25mOi9ldGMvbmdpbngvbmdpbnguY29uZiIKICAgICAgLSAiL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvcGxheWVyOi9ldGMvbmdpbngvaHRtbC8iCiAgICAgIC0gdHlwZTogYmluZAogICAgICAgIHNvdXJjZTogL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvLmh0cGFzc3dkCiAgICAgICAgdGFyZ2V0OiAvLmh0cGFzc3dkCiAgICAgIC0gIi9tbnQvZGlza3MvZGF0YS86L21udC8iCiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL3NjcmlwdHM6L3NjcmlwdHMiCgoKdm9sdW1lczoKICBsZXRzZW5jcnlwdDoK
  - path: /etc/rtmp-hls-server/player/index.html
    permissions: '0660'
    encoding: b64
    content: CjwhRE9DVFlQRSBodG1sPgo8aHRtbD4KICA8aGVhZD4KICAgIDx0aXRsZT5MaXZlIFN0cmVhbTwvdGl0bGU+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bGluayByZWw9Im1hbmlmZXN0IiBocmVmPSJtYW5pZmVzdC53ZWJtYW5pZmVzdCI+CiAgICA8bGluawogICAgICBocmVmPSJodHRwczovL3VucGtnLmNvbS92aWRlby5qc0A3L2Rpc3QvdmlkZW8tanMubWluLmNzcyIKICAgICAgcmVsPSJzdHlsZXNoZWV0IgogICAgLz4KCiAgICA8IS0tIENpdHkgLS0+CiAgICA8IS0tIDxsaW5rIGhyZWY9Imh0dHBzOi8vdW5wa2cuY29tL0B2aWRlb2pzL3RoZW1lc0AxL2Rpc3QvY2l0eS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+IC0tPgogICAgCiAgICA8IS0tIEZhbnRhc3kgLS0+CiAgICA8IS0tIDxsaW5rIGhyZWY9Imh0dHBzOi8vdW5wa2cuY29tL0B2aWRlb2pzL3RoZW1lc0AxL2Rpc3QvZmFudGFzeS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+IC0tPgogICAgCiAgICA8IS0tIEZvcmVzdCAtLT4KICAgIDwhLS0gPGxpbmsgaHJlZj0iaHR0cHM6Ly91bnBrZy5jb20vQHZpZGVvanMvdGhlbWVzQDEvZGlzdC9mb3Jlc3QvaW5kZXguY3NzIiByZWw9InN0eWxlc2hlZXQiPiAtLT4KICAgIAogICAgPCEtLSBTZWEgLS0+CiAgICA8bGluayBocmVmPSJodHRwczovL3VucGtnLmNvbS9AdmlkZW9qcy90aGVtZXNAMS9kaXN0L3NlYS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+CiAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogICAgICAjc3RyZWFtIHsKICAgICAgICBtYXJnaW46IGF1dG87CiAgICAgIH0KICAgICAgaDEgewogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgfQogICAgICAjZmlyZWZveC1hbmRyb2lkLXdhcm5pbmcgewogICAgICAgIGJvcmRlci1zdHlsZTogZGFzaGVkOwogICAgICAgIGJvcmRlci1jb2xvcjogcmVkOwogICAgICAgIGJvcmRlci13aWR0aDogMnB4OwogICAgICAgIGZvbnQtc2l6ZTogMS40ZW07CiAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgIHBhZGRpbmc6IDFlbTsKICAgICAgfQogICAgICAuaGlkZGVuIHsKICAgICAgICBkaXNwbGF5OiBub25lOzsKICAgICAgfQogICAgPC9zdHlsZT4KICA8L2hlYWQ+CiAgPGJvZHk+CiAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBibG9jazsiPgogICAgICA8aDE+SG9jaHplaXRzLVN0cmVhbSBKYW5hICYgU2ltb24gSGVpw593b2xmPC9oMT4KICAgICAgPHZpZGVvIAogICAgICAgIGlkPSdzdHJlYW0nIAogICAgICAgIGNsYXNzPSd2aWRlby1qcyB2anMtdGhlbWUtc2VhJyAKICAgICAgICB3aWR0aD0nNzIwJwogICAgICAgIGhlaWdodD0nNDgwJyAKICAgICAgICBwcmVsb2FkPWF1dG8gCiAgICAgICAgZGF0YS1zZXR1cD0ne30nIAogICAgICAgIGNvbnRyb2xzPgogICAgICAgIDxzb3VyY2UKICAgICAgICAgIHNyYz0iL2hscy9ob3NpamEubTN1OCIKICAgICAgICAgIHR5cGU9ImFwcGxpY2F0aW9uL3gtbXBlZ1VSTCI+CiAgICAgICAgCiAgICAgICAgPHNvdXJjZQogICAgICAgICAgc3JjPSIvZGFzaC9ob3NpamFfc3JjLm1wZCIKICAgICAgICAgIHR5cGU9ImFwcGxpY2F0aW9uL2Rhc2greG1sIj4KICAgICAgICA8cCBjbGFzcz0idmpzLW5vLWpzIj4KICAgICAgICAgIFRvIHZpZXcgdGhpcyB2aWRlbyBwbGVhc2UgZW5hYmxlIEphdmFTY3JpcHQsIGFuZCBjb25zaWRlciB1cGdyYWRpbmcgdG8gYQogICAgICAgICAgd2ViIGJyb3dzZXIgdGhhdAogICAgICAgICAgPGEgaHJlZj0iaHR0cHM6Ly92aWRlb2pzLmNvbS9odG1sNS12aWRlby1zdXBwb3J0LyIgdGFyZ2V0PSJfYmxhbmsiCiAgICAgICAgICAgID5zdXBwb3J0cyBIVE1MNSB2aWRlbzwvYQogICAgICAgICAgPgogICAgICAgIDwvcD4KICAgICAgPC92aWRlbz4KICAgICAgPGRpdiBpZD0iZmlyZWZveC1hbmRyb2lkLXdhcm5pbmciIGNsYXNzPSJoaWRkZW4iPgogICAgICAgIEJpdHRlIG51dHplIGRlbiBDaHJvbWUtQnJvd3NlciwgdW0gZWluZSBmZWhsZXJmcmVpZSBXaWVkZXJnYWJlIHp1IGdld8OkaHJsZWlzdGVuLgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPHNjcmlwdD4KICAgICAgd2luZG93LkhFTFBfSU1QUk9WRV9WSURFT0pTID0gZmFsc2U7CiAgICAgIHdpbmRvdy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwogICAgICAgIGNvbnNvbGUubG9nKHVzZXJBZ2VudCk7CiAgICAgICAgaWYoIHVzZXJBZ2VudC5pbmRleE9mKCJmaXJlZm94IikgIT0gLTEgJiYgdXNlckFnZW50LmluZGV4T2YoImFuZHJvaWQiKSAhPSAtMSApIHsKCiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3RyZWFtIikuY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiZmlyZWZveC1hbmRyb2lkLXdhcm5pbmciKS5jbGFzc0xpc3QucmVtb3ZlKCJoaWRkZW4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICA8L3NjcmlwdD4KICAgIDxzY3JpcHQgc3JjPSJodHRwczovL3Zqcy56ZW5jZG4ubmV0LzcuOC40L3ZpZGVvLm1pbi5qcyIgdHlwZT0iYXBwbGljYXRpb24vamF2YXNjcmlwdCI+PC9zY3JpcHQ+CiAgPC9ib2R5Pgo8L2h0bWw+Cg==
  - path: /etc/rtmp-hls-server/player/manifest.webmanifest
    permissions: '0660'
    encoding: b64
    content: CnsKICAic2hvcnRfbmFtZSI6ICJ3ZWRkaW5nLWxpdmUtc3RyZWFtIiwgCiAgIm5hbWUiOiAiSG9jaHplaXRzLUxpdmVzdHJlYW0gdm9uIEphbmEgJiBTaW1vbiBIZWnDn3dvbGYiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAgICAgICJtaW5pbWFsLXVpIiwKICAib3JpZW50YXRpb24iOiAgImxhbmRzY2FwZSIKfQo=
  - path: /etc/rtmp-hls-server/.htpasswd
    permissions: '0660'
    content: "viewer:$apr1$iSGnjknG$vMVE.YBE1xydDU4sFX2WI1"
  - path: /etc/rtmp-hls-server/scripts/process_recorded.sh
    permissions: '0775'
    encoding: b64
    content: CiMhL3Vzci9iaW4vZW52IGJhc2gKCmVjaG8gIlN0YXJ0aW5nIHNjcmlwdC4uLiIgfCB0ZWUgLWEgL3RtcC9zY3JpcHQubG9nCmVjaG8gJEAgfCB0ZWUgLWEgL3RtcC9zY3JpcHQubG9nCkRJUk5BTUU9IiR7MT99IgpCQVNFTkFNRT0iJHsyP30iCgp7CiAgc2V0IC1ldQogIGVjaG8gIkV4ZWN1dGluZy4uLiBmZm1wZWcgLWYgY29uY2F0IC1zYWZlIDAgLWkgPChmb3IgZiBpbiBcJChscyAtMSAvbW50L3JlY29yZC9cKi5mbHYpOyBkbyBlY2hvIFwiZmlsZSAnXCRmJ1wiOyBkb25lKSAtYyBjb3B5ICRESVJOQU1FLyRCQVNFTkFNRS5tcDQiCiAgZmZtcGVnIC1mIGNvbmNhdCAtc2FmZSAwIC1pIDwoZm9yIGYgaW4gJChscyAtMSAkRElSTkFNRS8qLmZsdik7IGRvIGVjaG8gImZpbGUgJyRmJyI7IGRvbmUpIC1jIGNvcHkgJERJUk5BTUUvJEJBU0VOQU1FLm1wNAp9IDI+JjEgfCB0ZWUgLWEgL3RtcC9zY3JpcHQubG9nCg==

runcmd:
  - set -x
  - systemctl stop rtmp-hls.service || true
  - 'ATTRIBUTES="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/)"'
  - PUBLISH_PW=""
  - PLAY_PW=""
  - |
    if echo "$ATTRIBUTES" | grep 'publish-password' > /dev/null
    then
      PUBLISH_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/publish-password)"
    fi
  - |
    if echo $ATTRIBUTES | grep 'play-password' > /dev/null
    then
      PLAY_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/play-password)"
    fi
  - mkdir -p /etc/rtmp-hls-server/auth_config/publish /etc/rtmp-hls-server/auth_config/play
  - echo "$PUBLISH_PW" | tee /etc/rtmp-hls-server/auth_config/publish/password
  - echo "$PLAY_PW" > /etc/rtmp-hls-server/auth_config/play/password
  - systemctl daemon-reload
  - |
    if echo "$ATTRIBUTES" | grep 'ssl-domain' > /dev/null && echo "$ATTRIBUTES" | grep 'ssl-email' > /dev/null
    then
      LETSENCRYPT_EMAIL="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/ssl-email)"
      LETSENCRYPT_DOMAIN="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/ssl-domain)"
      
      docker run --rm --name certbot -v "/mnt/disks/data/letsencrypt:/etc/letsencrypt" -p 80:80 -p 443:443 certbot/certbot \
      certonly --agree-tos --standalone -m $LETSENCRYPT_EMAIL -d $LETSENCRYPT_DOMAIN
      sed -i "s/\[\[SERVER_NAME\]\]/$LETSENCRYPT_DOMAIN/g" /etc/rtmp-hls-server/nginx_ssl.conf
      cp /etc/rtmp-hls-server/nginx_ssl.conf /etc/rtmp-hls-server/nginx.conf
    else
      cp /etc/rtmp-hls-server/nginx_no_ssl.conf /etc/rtmp-hls-server/nginx.conf
    fi
  - systemctl start rtmp-hls.service
  - while [[ -z "$(docker ps --filter "name=rtmp-hls-server_rtmp-hls_1" --filter "status=running" --format "{{.ID}}" 2> /dev/null )" ]]; do sleep 3; done
  - docker exec rtmp-hls-server_rtmp-hls_1 bash -c "mkdir -p /mnt/record"

bootcmd:
  - rm -r /etc/rtmp-hls-server
  - mkdir -p /mnt/disks/data
  - |
    mount -o discard,defaults /dev/disk/by-id/scsi-0Google_PersistentDisk_data /mnt/disks/data || {
      echo "data disk not formatted! Formatting now..."
      mkfs.ext4 /dev/disk/by-id/scsi-0Google_PersistentDisk_data
      mount -o discard,defaults /dev/disk/by-id/scsi-0Google_PersistentDisk_data /mnt/disks/data
    }
  