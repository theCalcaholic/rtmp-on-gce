#cloud-config

  
write_files:
  - path: /etc/systemd/system/rtmp-hls.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Start the rtmp authentication server

      [Service]
      ExecStart=/usr/bin/docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc/rtmp-hls-server/:/etc/rtmp-hls-server/ -w /etc/rtmp-hls-server/ docker/compose:latest up
      ExecStop=/usr/bin/docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc/rtmp-hls-server/:/etc/rtmp-hls-server/ -w /etc/rtmp-hls-server/ docker/compose:latest down
  - path: /etc/rtmp-hls-server/nginx.conf
    permissions: '0660'
    encoding: b64
    content: Cndvcmtlcl9wcm9jZXNzZXMgIGF1dG87Cndvcmtlcl9ybGltaXRfbm9maWxlIDEwMDAwMDsKI2Vycm9yX2xvZyAgbG9ncy9lcnJvci5sb2c7CgpldmVudHMgewogIHdvcmtlcl9jb25uZWN0aW9ucyAgNDA5NjsKICAjZXBvbGw7Cn0KCiMgUlRNUCBjb25maWd1cmF0aW9uCnJ0bXAgewogIHNlcnZlciB7CiAgICBsaXN0ZW4gMTkzNTsgIyBMaXN0ZW4gb24gc3RhbmRhcmQgUlRNUCBwb3J0CiAgICBjaHVua19zaXplIDQwOTY7IAogICAgcGluZyAzMHM7CiAgICBub3RpZnlfbWV0aG9kIGdldDsKCiAgICAjIFRoaXMgYXBwbGljYXRpb24gaXMgdG8gYWNjZXB0IGluY29taW5nIHN0cmVhbQogICAgYXBwbGljYXRpb24gbGl2ZSB7CiAgICAgIGxpdmUgb247ICMgQWxsb3dzIGxpdmUgaW5wdXQKICAgICAgcGxheV9yZXN0YXJ0IG9uOwogICAgICByZWNvcmQgb2ZmOwogICAgICBvbl9wdWJsaXNoIGh0dHA6Ly9zaW1wbGUtYXV0aC9wdWJsaXNoOwoKICAgICAgIyBmb3IgZWFjaCByZWNlaXZlZCBzdHJlYW0sIHRyYW5zY29kZSBmb3IgYWRhcHRpdmUgc3RyZWFtaW5nCiAgICAgICMgVGhpcyBzaW5nbGUgZmZtcGVnIGNvbW1hbmQgdGFrZXMgdGhlIGlucHV0IGFuZCB0cmFuc2Zvcm1zCiAgICAgICMgdGhlIHNvdXJjZSBpbnRvIDQgZGlmZmVyZW50IHN0cmVhbXMgd2l0aCBkaWZmZXJlbnQgYml0cmF0ZXMKICAgICAgIyBhbmQgcXVhbGl0aWVzLiAjIHRoZXNlIHNldHRpbmdzIHJlc3BlY3QgdGhlIGFzcGVjdCByYXRpby4KICAgICAgZXhlY19wdXNoICAvdXNyL2xvY2FsL2Jpbi9mZm1wZWcgLWkgcnRtcDovL2xvY2FsaG9zdDoxOTM1LyRhcHAvJG5hbWUgLWFzeW5jIDEgLXZzeW5jIC0xCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtYzphIGFhYyAtYjp2IDI1NmsgIC1iOmEgNjRrICAtdmYgInNjYWxlPTQ4MDp0cnVuYyhvdy9hLzIpKjIiICAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9sb3cKICAgICAgICAgICAgICAgICAgLWM6diBsaWJ4MjY0IC1jOmEgYWFjIC1iOnYgNzY4ayAgLWI6YSAxMjhrIC12ZiAic2NhbGU9NzIwOnRydW5jKG93L2EvMikqMiIgIC10dW5lIHplcm9sYXRlbmN5IC1wcmVzZXQgc3VwZXJmYXN0IC1jcmYgMjMgLWYgZmx2IHJ0bXA6Ly8xMjcuMC4wLjE6MTkzNS9zaG93LyRuYW1lX21pZAogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLWM6YSBhYWMgLWI6diAxMDI0ayAtYjphIDEyOGsgLXZmICJzY2FsZT05NjA6dHJ1bmMob3cvYS8yKSoyIiAgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovLzEyNy4wLjAuMToxOTM1L3Nob3cvJG5hbWVfaGlnaAogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLWM6YSBhYWMgLWI6diAxOTIwayAtYjphIDEyOGsgLXZmICJzY2FsZT0xMjgwOnRydW5jKG93L2EvMikqMiIgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovLzEyNy4wLjAuMToxOTM1L3Nob3cvJG5hbWVfaGQ3MjAKICAgICAgICAgICAgICAgICAgLWMgY29weSAtZiBmbHYgcnRtcDovL2xvY2FsaG9zdDoxOTM1L3Nob3cvJG5hbWVfc3JjOwogICAgfQoKICAgICMgVGhpcyBpcyB0aGUgSExTIGFwcGxpY2F0aW9uCiAgICBhcHBsaWNhdGlvbiBzaG93IHsKICAgICAgbGl2ZSBvbjsgIyBBbGxvd3MgbGl2ZSBpbnB1dCBmcm9tIGFib3ZlIGFwcGxpY2F0aW9uCiAgICAgIHBsYXlfcmVzdGFydCBvbjsKICAgICAgYWxsb3cgcHVibGlzaCAxMjcuMC4wLjE7CiAgICAgIGRlbnkgcHVibGlzaCBhbGw7CiAgICAgIGRlbnkgcGxheSBhbGw7ICMgZGlzYWJsZSBjb25zdW1pbmcgdGhlIHN0cmVhbSBmcm9tIG5naW54IGFzIHJ0bXAKICAgICAgCiAgICAgIGhscyBvbjsgIyBFbmFibGUgSFRUUCBMaXZlIFN0cmVhbWluZwogICAgICBobHNfZnJhZ21lbnQgMzsKICAgICAgaGxzX3BsYXlsaXN0X2xlbmd0aCA2MDsKICAgICAgaGxzX2NsZWFudXAgb247CiAgICAgICNobHNfY29udGludW91cyBvbjsKICAgICAgaGxzX3BhdGggL21udC9obHMvOyAgIyBobHMgZnJhZ21lbnRzIHBhdGgKICAgICAgIyBJbnN0cnVjdCBjbGllbnRzIHRvIGFkanVzdCByZXNvbHV0aW9uIGFjY29yZGluZyB0byBiYW5kd2lkdGgKICAgICAgaGxzX3ZhcmlhbnQgX3NyYyBCQU5EV0lEVEg9NDA5NjAwMDsgIyBTb3VyY2UgYml0cmF0ZSwgc291cmNlIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX2hkNzIwIEJBTkRXSURUSD0yMDQ4MDAwOyAjIEhpZ2ggYml0cmF0ZSwgSEQgNzIwcCByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9oaWdoIEJBTkRXSURUSD0xMTUyMDAwOyAjIEhpZ2ggYml0cmF0ZSwgaGlnaGVyLXRoYW4tU0QgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfbWlkIEJBTkRXSURUSD00NDgwMDA7ICMgTWVkaXVtIGJpdHJhdGUsIFNEIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX2xvdyBCQU5EV0lEVEg9Mjg4MDAwOyAjIExvdyBiaXRyYXRlLCBzdWItU0QgcmVzb2x1dGlvbgogICAgICAKICAgICAgIyBNUEVHLURBU0gKICAgICAgZGFzaCBvbjsKICAgICAgZGFzaF9wYXRoIC9tbnQvZGFzaC87ICAjIGRhc2ggZnJhZ21lbnRzIHBhdGgKICAgICAgZGFzaF9mcmFnbWVudCAzOwogICAgICBkYXNoX3BsYXlsaXN0X2xlbmd0aCAzMDsJCQkKICAgIH0KICB9Cn0KCgpodHRwIHsKICBzZW5kZmlsZSBvZmY7CiAgdGNwX25vcHVzaCBvbjsKICBkaXJlY3RpbyA1MTI7CiAgIyBhaW8gb247CiAgb3Blbl9maWxlX2NhY2hlIG1heD0yMDAwMDAgaW5hY3RpdmU9MjBzOwogIG9wZW5fZmlsZV9jYWNoZV92YWxpZCAzMHM7CiAgb3Blbl9maWxlX2NhY2hlX21pbl91c2VzIDI7CiAgb3Blbl9maWxlX2NhY2hlX2Vycm9ycyBvbjsKICBnemlwIG9uOwogIGd6aXBfbWluX2xlbmd0aCAxMDI0MDsKICBnemlwX2NvbXBfbGV2ZWwgMTsKICBnemlwX3Zhcnkgb247CiAgZ3ppcF9kaXNhYmxlIG1zaWU2OwogIGd6aXBfcHJveGllZCBleHBpcmVkIG5vLWNhY2hlIG5vLXN0b3JlIHByaXZhdGUgYXV0aDsKICBnemlwX3R5cGVzCiAgICB0ZXh0L2NzcwogICAgdGV4dC9qYXZhc2NyaXB0CiAgICB0ZXh0L3htbAogICAgdGV4dC9wbGFpbgogICAgdGV4dC94LWNvbXBvbmVudAogICAgYXBwbGljYXRpb24vamF2YXNjcmlwdAogICAgYXBwbGljYXRpb24veC1qYXZhc2NyaXB0CiAgICBhcHBsaWNhdGlvbi9qc29uCiAgICBhcHBsaWNhdGlvbi94bWwKICAgIGFwcGxpY2F0aW9uL3Jzcyt4bWwKICAgIGFwcGxpY2F0aW9uL2F0b20reG1sCiAgICBmb250L3RydWV0eXBlCiAgICBmb250L29wZW50eXBlCiAgICBhcHBsaWNhdGlvbi92bmQubXMtZm9udG9iamVjdAogICAgaW1hZ2Uvc3ZnK3htbDsKICAjYWNjZXNzX2xvZyBsb2dzL2FjY2Vzcy5sb2cgbWFpbjsKICAKICAjIEhUVFAgc2VydmVyIHJlcXVpcmVkIHRvIHNlcnZlIHRoZSBwbGF5ZXIgYW5kIEhMUyBmcmFnbWVudHMKICBzZXJ2ZXIgewogICAgbGlzdGVuIDgwOwoKICAgIGxvY2F0aW9uIC8gewogICAgICBhdXRoX2Jhc2ljICJBdXRoZW50aWNhdGlvbiAodXNlcj12aWV3ZXIpIjsKICAgICAgYXV0aF9iYXNpY191c2VyX2ZpbGUgLy5odHBhc3N3ZDsKCiAgICAgIHJvb3QgL2V0Yy9uZ2lueC9odG1sOwogICAgICBpbmRleCBpbmRleC5odG1sIGluZGV4Lmh0bTsKICAgIH0KCiAgICBsb2NhdGlvbiAvbWFuaWZlc3Qud2VibWFuaWZlc3QgewogICAgICBhdXRoX2Jhc2ljIG5vOwogICAgICByb290IC9ldGMvbmdpbngvaHRtbDsKICAgICAgaW5kZXggaW5kZXguaHRtbCBpbmRleC5odG07CiAgICB9CiAgICAjIFNlcnZlIEhMUyBmcmFnbWVudHMKICAgIGxvY2F0aW9uIC9obHMgewogICAgICB0eXBlcyB7CiAgICAgICAgYXBwbGljYXRpb24vdm5kLmFwcGxlLm1wZWd1cmwgbTN1ODsKICAgICAgICB2aWRlby9tcDJ0IHRzOwogICAgICB9CiAgICAgIAogICAgICByb290IC9tbnQ7CgogICAgICBhZGRfaGVhZGVyIENhY2hlLUNvbnRyb2wgbm8tY2FjaGU7ICMgRGlzYWJsZSBjYWNoZQogICAgICAKICAgICAgIyBDT1JTIHNldHVwCiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonIGFsd2F5czsKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtRXhwb3NlLUhlYWRlcnMnICdDb250ZW50LUxlbmd0aCc7CiAgICAgIAogICAgICAjIGFsbG93IENPUlMgcHJlZmxpZ2h0IHJlcXVlc3RzCiAgICAgIGlmICgkcmVxdWVzdF9tZXRob2QgPSAnT1BUSU9OUycpIHsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJzsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1NYXgtQWdlJyAxNzI4MDAwOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtVHlwZScgJ3RleHQvcGxhaW4gY2hhcnNldD1VVEYtOCc7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1MZW5ndGgnIDA7CiAgICAgICAgcmV0dXJuIDIwNDsKICAgICAgfQogICAgfQogICAgCiAgICAjIFNlcnZlIERBU0ggZnJhZ21lbnRzCiAgICBsb2NhdGlvbiAvZGFzaCB7CiAgICAgIHR5cGVzIHsKICAgICAgICBhcHBsaWNhdGlvbi9kYXNoK3htbCBtcGQ7CiAgICAgICAgdmlkZW8vbXA0IG1wNDsKICAgICAgfQoKICAgICAgcm9vdCAvbW50OwogICAgICAKICAgICAgYWRkX2hlYWRlciBDYWNoZS1Db250cm9sIG5vLWNhY2hlOyAjIERpc2FibGUgY2FjaGUKCgogICAgICAjIENPUlMgc2V0dXAKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKicgYWx3YXlzOwogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1FeHBvc2UtSGVhZGVycycgJ0NvbnRlbnQtTGVuZ3RoJzsKCiAgICAgICMgQWxsb3cgQ09SUyBwcmVmbGlnaHQgcmVxdWVzdHMKICAgICAgaWYgKCRyZXF1ZXN0X21ldGhvZCA9ICdPUFRJT05TJykgewogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonOwogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLU1heC1BZ2UnIDE3MjgwMDA7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1UeXBlJyAndGV4dC9wbGFpbiBjaGFyc2V0PVVURi04JzsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LUxlbmd0aCcgMDsKICAgICAgICByZXR1cm4gMjA0OwogICAgICB9CiAgICB9CQkKICAgIAogICAgIyBUaGlzIFVSTCBwcm92aWRlcyBSVE1QIHN0YXRpc3RpY3MgaW4gWE1MCiAgICBsb2NhdGlvbiAvc3RhdCB7CiAgICAgIHJ0bXBfc3RhdCBhbGw7CiAgICAgIHJ0bXBfc3RhdF9zdHlsZXNoZWV0IHN0YXQueHNsOyAjIFVzZSBzdGF0LnhzbCBzdHlsZXNoZWV0IAogICAgfQoKICAgIGxvY2F0aW9uIC9zdGF0LnhzbCB7CiAgICAgICMgWE1MIHN0eWxlc2hlZXQgdG8gdmlldyBSVE1QIHN0YXRzLgogICAgICByb290IC91c3IvbG9jYWwvbmdpbngvaHRtbDsKICAgIH0KCiAgfQp9Cg==
  - path: /etc/rtmp-hls-server/docker-compose.yml
    permissions: '0660'
    encoding: b64
    content: CnZlcnNpb246ICczLjInCnNlcnZpY2VzOgogIHNpbXBsZS1hdXRoOgogICAgaW1hZ2U6IHRoZWNhbGNhaG9saWMvc2ltcGxlLWF1dGgKICAgIHZvbHVtZXM6CiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL2F1dGhfY29uZmlnOi9ldGMvYXV0aF9jb25maWcvIgogICAgcmVzdGFydDogdW5sZXNzLXN0b3BwZWQKICBydG1wLWhsczoKICAgIGltYWdlOiBhbHF1dGFtaS9ydG1wLWhsczpsYXRlc3QtYWxwaW5lCiAgICBwb3J0czoKICAgICAgLSAiODA6ODAiCiAgICAgIC0gIjQ0Mzo0NDMiCiAgICAgIC0gIjE5MzU6MTkzNSIKICAgIGRlcGVuZHNfb246CiAgICAgIC0gc2ltcGxlLWF1dGgKICAgIHJlc3RhcnQ6IHVubGVzcy1zdG9wcGVkCiAgICB2b2x1bWVzOgogICAgICAtIHR5cGU6IHZvbHVtZQogICAgICAgIHNvdXJjZTogbGV0c2VuY3J5cHQKICAgICAgICB0YXJnZXQ6IC9ldGMvbGV0c2VuY3J5cHQKICAgICAgICByZWFkX29ubHk6IHRydWUKICAgICAgLSAiL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvbmdpbnguY29uZjovZXRjL25naW54L25naW54LmNvbmYiCiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL3BsYXllcjovZXRjL25naW54L2h0bWwvIgogICAgICAtIHR5cGU6IGJpbmQKICAgICAgICBzb3VyY2U6IC9ldGMvcnRtcC1obHMtc2VydmVyLy5odHBhc3N3ZAogICAgICAgIHRhcmdldDogLy5odHBhc3N3ZAogICAgICAtICIvbW50L2Rpc2tzL2RhdGEvOi9tbnQvIgoKCnZvbHVtZXM6CiAgbGV0c2VuY3J5cHQ6Cg==
  - path: /etc/rtmp-hls-server/player/index.html
    permissions: '0664'
    encoding: b64
    content: CjwhRE9DVFlQRSBodG1sPgo8aHRtbD4KICA8aGVhZD4KICAgIDx0aXRsZT5MaXZlIFN0cmVhbTwvdGl0bGU+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bGluayByZWw9Im1hbmlmZXN0IiBocmVmPSJtYW5pZmVzdC53ZWJtYW5pZmVzdCI+CiAgICA8bGluawogICAgICBocmVmPSJodHRwczovL3VucGtnLmNvbS92aWRlby5qc0A3L2Rpc3QvdmlkZW8tanMubWluLmNzcyIKICAgICAgcmVsPSJzdHlsZXNoZWV0IgogICAgLz4KCiAgICA8IS0tIENpdHkgLS0+CiAgICA8IS0tIDxsaW5rIGhyZWY9Imh0dHBzOi8vdW5wa2cuY29tL0B2aWRlb2pzL3RoZW1lc0AxL2Rpc3QvY2l0eS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+IC0tPgogICAgCiAgICA8IS0tIEZhbnRhc3kgLS0+CiAgICA8IS0tIDxsaW5rIGhyZWY9Imh0dHBzOi8vdW5wa2cuY29tL0B2aWRlb2pzL3RoZW1lc0AxL2Rpc3QvZmFudGFzeS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+IC0tPgogICAgCiAgICA8IS0tIEZvcmVzdCAtLT4KICAgIDwhLS0gPGxpbmsgaHJlZj0iaHR0cHM6Ly91bnBrZy5jb20vQHZpZGVvanMvdGhlbWVzQDEvZGlzdC9mb3Jlc3QvaW5kZXguY3NzIiByZWw9InN0eWxlc2hlZXQiPiAtLT4KICAgIAogICAgPCEtLSBTZWEgLS0+CiAgICA8bGluayBocmVmPSJodHRwczovL3VucGtnLmNvbS9AdmlkZW9qcy90aGVtZXNAMS9kaXN0L3NlYS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+CiAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogICAgICAjc3RyZWFtIHsKICAgICAgICBtYXJnaW46IGF1dG87CiAgICAgIH0KICAgICAgaDEgewogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgfQogICAgPC9zdHlsZT4KICA8L2hlYWQ+CiAgPGJvZHk+CiAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBibG9jazsiPgogICAgICA8aDE+SG9jaHplaXRzLVN0cmVhbSBKYW5hICYgU2ltb24gSGVpw593b2xmPC9oMT4KICAgICAgPHZpZGVvIAogICAgICAgIGlkPSdzdHJlYW0nIAogICAgICAgIGNsYXNzPSd2aWRlby1qcyB2anMtdGhlbWUtc2VhJyAKICAgICAgICB3aWR0aD0nNzIwJwogICAgICAgIGhlaWdodD0nNDgwJyAKICAgICAgICBwcmVsb2FkPWF1dG8gCiAgICAgICAgZGF0YS1zZXR1cD0ne30nIAogICAgICAgIGNvbnRyb2xzPgogICAgICAgIDxzb3VyY2UKICAgICAgICAgIHNyYz0iL2hscy90ZXN0Lm0zdTgiCiAgICAgICAgICB0eXBlPSJhcHBsaWNhdGlvbi94LW1wZWdVUkwiPgogICAgICAgIAogICAgICAgIDxzb3VyY2UKICAgICAgICAgIHNyYz0iL2Rhc2gvdGVzdF9zcmMubXBkIgogICAgICAgICAgdHlwZT0iYXBwbGljYXRpb24vZGFzaCt4bWwiPgogICAgICAgIDxwIGNsYXNzPSJ2anMtbm8tanMiPgogICAgICAgICAgVG8gdmlldyB0aGlzIHZpZGVvIHBsZWFzZSBlbmFibGUgSmF2YVNjcmlwdCwgYW5kIGNvbnNpZGVyIHVwZ3JhZGluZyB0byBhCiAgICAgICAgICB3ZWIgYnJvd3NlciB0aGF0CiAgICAgICAgICA8YSBocmVmPSJodHRwczovL3ZpZGVvanMuY29tL2h0bWw1LXZpZGVvLXN1cHBvcnQvIiB0YXJnZXQ9Il9ibGFuayIKICAgICAgICAgICAgPnN1cHBvcnRzIEhUTUw1IHZpZGVvPC9hCiAgICAgICAgICA+CiAgICAgICAgPC9wPgogICAgICA8L3ZpZGVvPgogICAgPC9kaXY+CiAgICA8c2NyaXB0PgogICAgICB3aW5kb3cuSEVMUF9JTVBST1ZFX1ZJREVPSlMgPSBmYWxzZTsKICAgIDwvc2NyaXB0PgogICAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vdmpzLnplbmNkbi5uZXQvNy44LjQvdmlkZW8ubWluLmpzIiB0eXBlPSJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0Ij48L3NjcmlwdD4KICA8L2JvZHk+CjwvaHRtbD4K
  - path: /etc/rtmp-hls-server/player/manifest.webmanifest
    permissions: '0664'
    encoding: b64
    content: CnsKICAic2hvcnRfbmFtZSI6ICJ3ZWRkaW5nLWxpdmUtc3RyZWFtIiwgCiAgIm5hbWUiOiAiSG9jaHplaXRzLUxpdmVzdHJlYW0gdm9uIEphbmEgJiBTaW1vbiBIZWnDn3dvbGYiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAgICAgICJtaW5pbWFsLXVpIiwKICAib3JpZW50YXRpb24iOiAgImxhbmRzY2FwZSIKfQo=
  - path: /etc/rtmp-hls-server/.htpasswd
    permissions: '0660'
    content: "viewer:$apr1$iSGnjknG$vMVE.YBE1xydDU4sFX2WI1"

runcmd:
  - 'PUBLiSH_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/publish-password)"'
  - 'PLAY_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/play-password)"'
  - mkdir -p /etc/rtmp-hls-server/auth_config/publish /etc/rtmp-hls-server/auth_config/play
  - echo "$PUBLISH_PW" > /etc/rtmp-hls-server/auth_config/publish/password
  - echo "$PLAY_PW" > /etc/rtmp-hls-server/auth_config/play/password
  - systemctl daemon-reload
  - systemctl start rtmp-hls.service
  - while ! docker ps | grep rtmp-hls-server_rtmp-hls_1; do sleep 3; done
  - docker exec rtmp-hls-server_rtmp-hls_1 bash -c "chown nobody:nobody /.htpasswd"

bootcmd:
  - mkdir -p /mnt/disks/data
  - |
    mount -o discard,defaults /dev/disk/by-id/scsi-0Google_PersistentDisk_data /mnt/disks/data || {
      echo "data disk not formatted! Formatting now..."
      mkfs.ext4 /dev/disk/by-id/scsi-0Google_PersistentDisk_data
      mount -o discard,defaults /dev/disk/by-id/scsi-0Google_PersistentDisk_data /mnt/disks/data
    }
  