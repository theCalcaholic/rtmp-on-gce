#cloud-config

  
write_files:
  - path: /etc/systemd/system/rtmp-hls.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Start a simple docker container

      [Service]
      ExecStart=/usr/bin/docker run --rm -p 1935:1935 -p 80:80 -p 443:443 -v /etc/rtmp-hls-server/nginx.conf:/etc/nginx/nginx.conf --name=rtmp-hls-server alqutami/rtmp-hls
      ExecStop=/usr/bin/docker stop rtmp-hls-server
      ExecStopPost=/usr/bin/docker rm rtmp-hls-server
  
  - path: /etc/systemd/system/rtmp-hls.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Start the rtmp authentication server

      [Service]
      ExecStart=/usr/bin/docker run --rm -p 127.0.0.1:80 -p 80:80 -p 443:443 -v /etc/rtmp-hls-server/nginx.conf:/etc/nginx/nginx.conf --name=rtmp-hls-server alqutami/rtmp-hls
      ExecStop=/usr/bin/docker stop rtmp-hls-server
      ExecStopPost=/usr/bin/docker rm rtmp-hls-server
  - path: /etc/rtmp-hls-server/nginx.conf
    permissions: '0660'
    encoding: b64
    content: Cndvcmtlcl9wcm9jZXNzZXMgIGF1dG87CiNlcnJvcl9sb2cgIGxvZ3MvZXJyb3IubG9nOwoKZXZlbnRzIHsKICB3b3JrZXJfY29ubmVjdGlvbnMgIDEwMjQ7Cn0KCiMgUlRNUCBjb25maWd1cmF0aW9uCnJ0bXAgewogIHNlcnZlciB7CiAgICBsaXN0ZW4gMTkzNTsgIyBMaXN0ZW4gb24gc3RhbmRhcmQgUlRNUCBwb3J0CiAgICBjaHVua19zaXplIDQwMDA7IAogICAgIyBwaW5nIDMwczsKICAgICMgbm90aWZ5X21ldGhvZCBnZXQ7CgogICAgIyBUaGlzIGFwcGxpY2F0aW9uIGlzIHRvIGFjY2VwdCBpbmNvbWluZyBzdHJlYW0KICAgIGFwcGxpY2F0aW9uIGxpdmUgewogICAgICBsaXZlIG9uOyAjIEFsbG93cyBsaXZlIGlucHV0CiAgICAgIG9uX3B1Ymxpc2ggaHR0cDovL3NpbXBsZS1hdXRoL3B1Ymxpc2g7CgogICAgICAjIGZvciBlYWNoIHJlY2VpdmVkIHN0cmVhbSwgdHJhbnNjb2RlIGZvciBhZGFwdGl2ZSBzdHJlYW1pbmcKICAgICAgIyBUaGlzIHNpbmdsZSBmZm1wZWcgY29tbWFuZCB0YWtlcyB0aGUgaW5wdXQgYW5kIHRyYW5zZm9ybXMKICAgICAgIyB0aGUgc291cmNlIGludG8gNCBkaWZmZXJlbnQgc3RyZWFtcyB3aXRoIGRpZmZlcmVudCBiaXRyYXRlcwogICAgICAjIGFuZCBxdWFsaXRpZXMuICMgdGhlc2Ugc2V0dGluZ3MgcmVzcGVjdCB0aGUgYXNwZWN0IHJhdGlvLgogICAgICBleGVjX3B1c2ggIC91c3IvbG9jYWwvYmluL2ZmbXBlZyAtaSBydG1wOi8vbG9jYWxob3N0OjE5MzUvJGFwcC8kbmFtZSAtYXN5bmMgMSAtdnN5bmMgLTEKICAgICAgICAgICAgICAgICAgLWM6diBsaWJ4MjY0IC1jOmEgYWFjIC1iOnYgMjU2ayAgLWI6YSA2NGsgIC12ZiAic2NhbGU9NDgwOnRydW5jKG93L2EvMikqMiIgIC10dW5lIHplcm9sYXRlbmN5IC1wcmVzZXQgc3VwZXJmYXN0IC1jcmYgMjMgLWYgZmx2IHJ0bXA6Ly9sb2NhbGhvc3Q6MTkzNS9zaG93LyRuYW1lX2xvdwogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLWM6YSBhYWMgLWI6diA3NjhrICAtYjphIDEyOGsgLXZmICJzY2FsZT03MjA6dHJ1bmMob3cvYS8yKSoyIiAgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovL2xvY2FsaG9zdDoxOTM1L3Nob3cvJG5hbWVfbWlkCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtYzphIGFhYyAtYjp2IDEwMjRrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTk2MDp0cnVuYyhvdy9hLzIpKjIiICAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9oaWdoCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtYzphIGFhYyAtYjp2IDE5MjBrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTEyODA6dHJ1bmMob3cvYS8yKSoyIiAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9oZDcyMAogICAgICAgICAgICAgICAgICAtYyBjb3B5IC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9zcmM7CiAgICB9CgogICAgIyBUaGlzIGlzIHRoZSBITFMgYXBwbGljYXRpb24KICAgIGFwcGxpY2F0aW9uIHNob3cgewogICAgICBsaXZlIG9uOyAjIEFsbG93cyBsaXZlIGlucHV0IGZyb20gYWJvdmUgYXBwbGljYXRpb24KICAgICAgZGVueSBwbGF5IGFsbDsgIyBkaXNhYmxlIGNvbnN1bWluZyB0aGUgc3RyZWFtIGZyb20gbmdpbnggYXMgcnRtcAogICAgICAKICAgICAgaGxzIG9uOyAjIEVuYWJsZSBIVFRQIExpdmUgU3RyZWFtaW5nCiAgICAgIGhsc19mcmFnbWVudCAzOwogICAgICBobHNfcGxheWxpc3RfbGVuZ3RoIDIwOwogICAgICBobHNfcGF0aCAvbW50L2hscy87ICAjIGhscyBmcmFnbWVudHMgcGF0aAogICAgICAjIEluc3RydWN0IGNsaWVudHMgdG8gYWRqdXN0IHJlc29sdXRpb24gYWNjb3JkaW5nIHRvIGJhbmR3aWR0aAogICAgICBobHNfdmFyaWFudCBfc3JjIEJBTkRXSURUSD00MDk2MDAwOyAjIFNvdXJjZSBiaXRyYXRlLCBzb3VyY2UgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfaGQ3MjAgQkFORFdJRFRIPTIwNDgwMDA7ICMgSGlnaCBiaXRyYXRlLCBIRCA3MjBwIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX2hpZ2ggQkFORFdJRFRIPTExNTIwMDA7ICMgSGlnaCBiaXRyYXRlLCBoaWdoZXItdGhhbi1TRCByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9taWQgQkFORFdJRFRIPTQ0ODAwMDsgIyBNZWRpdW0gYml0cmF0ZSwgU0QgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfbG93IEJBTkRXSURUSD0yODgwMDA7ICMgTG93IGJpdHJhdGUsIHN1Yi1TRCByZXNvbHV0aW9uCiAgICAgIAogICAgICAjIE1QRUctREFTSAogICAgICBkYXNoIG9uOwogICAgICBkYXNoX3BhdGggL21udC9kYXNoLzsgICMgZGFzaCBmcmFnbWVudHMgcGF0aAogICAgICBkYXNoX2ZyYWdtZW50IDM7CiAgICAgIGRhc2hfcGxheWxpc3RfbGVuZ3RoIDIwOwkJCQogICAgfQogIH0KfQoKCmh0dHAgewogIHNlbmRmaWxlIG9mZjsKICB0Y3Bfbm9wdXNoIG9uOwogIGRpcmVjdGlvIDUxMjsKICAjIGFpbyBvbjsKICAKICAjIEhUVFAgc2VydmVyIHJlcXVpcmVkIHRvIHNlcnZlIHRoZSBwbGF5ZXIgYW5kIEhMUyBmcmFnbWVudHMKICBzZXJ2ZXIgewogICAgbGlzdGVuIDgwOwoKICAgICMgbG9jYXRpb24gL3B1Ymxpc2hfYXV0aCB7CiAgICAjICAgIyBzZXRfcHVibGlzaF9hdXRoX3B3CiAgICAjICAgaWYgKCRhcmdfcHNrID0gJ3NlY3JldCcpIHsKICAgICMgICAgIHJldHVybiAyMDE7CiAgICAjICAgfQogICAgIyAgIHJldHVybiA0MDQ7CiAgICAjIH0KICAgIAogICAgIyBTZXJ2ZSBITFMgZnJhZ21lbnRzCiAgICBsb2NhdGlvbiAvaGxzIHsKICAgICAgdHlwZXMgewogICAgICAgIGFwcGxpY2F0aW9uL3ZuZC5hcHBsZS5tcGVndXJsIG0zdTg7CiAgICAgICAgdmlkZW8vbXAydCB0czsKICAgICAgfQogICAgICAKICAgICAgcm9vdCAvbW50OwoKICAgICAgYWRkX2hlYWRlciBDYWNoZS1Db250cm9sIG5vLWNhY2hlOyAjIERpc2FibGUgY2FjaGUKICAgICAgCiAgICAgICMgQ09SUyBzZXR1cAogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJyBhbHdheXM7CiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUV4cG9zZS1IZWFkZXJzJyAnQ29udGVudC1MZW5ndGgnOwogICAgICAKICAgICAgIyBhbGxvdyBDT1JTIHByZWZsaWdodCByZXF1ZXN0cwogICAgICBpZiAoJHJlcXVlc3RfbWV0aG9kID0gJ09QVElPTlMnKSB7CiAgICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKic7CiAgICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtTWF4LUFnZScgMTcyODAwMDsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LVR5cGUnICd0ZXh0L3BsYWluIGNoYXJzZXQ9VVRGLTgnOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtTGVuZ3RoJyAwOwogICAgICAgIHJldHVybiAyMDQ7CiAgICAgIH0KICAgIH0KICAgIAogICAgIyBTZXJ2ZSBEQVNIIGZyYWdtZW50cwogICAgbG9jYXRpb24gL2Rhc2ggewogICAgICB0eXBlcyB7CiAgICAgICAgYXBwbGljYXRpb24vZGFzaCt4bWwgbXBkOwogICAgICAgIHZpZGVvL21wNCBtcDQ7CiAgICAgIH0KCiAgICAgIHJvb3QgL21udDsKICAgICAgCiAgICAgIGFkZF9oZWFkZXIgQ2FjaGUtQ29udHJvbCBuby1jYWNoZTsgIyBEaXNhYmxlIGNhY2hlCgoKICAgICAgIyBDT1JTIHNldHVwCiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonIGFsd2F5czsKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtRXhwb3NlLUhlYWRlcnMnICdDb250ZW50LUxlbmd0aCc7CgogICAgICAjIEFsbG93IENPUlMgcHJlZmxpZ2h0IHJlcXVlc3RzCiAgICAgIGlmICgkcmVxdWVzdF9tZXRob2QgPSAnT1BUSU9OUycpIHsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJzsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1NYXgtQWdlJyAxNzI4MDAwOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtVHlwZScgJ3RleHQvcGxhaW4gY2hhcnNldD1VVEYtOCc7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1MZW5ndGgnIDA7CiAgICAgICAgcmV0dXJuIDIwNDsKICAgICAgfQogICAgfQkJCiAgICAKICAgICMgVGhpcyBVUkwgcHJvdmlkZXMgUlRNUCBzdGF0aXN0aWNzIGluIFhNTAogICAgbG9jYXRpb24gL3N0YXQgewogICAgICBydG1wX3N0YXQgYWxsOwogICAgICBydG1wX3N0YXRfc3R5bGVzaGVldCBzdGF0LnhzbDsgIyBVc2Ugc3RhdC54c2wgc3R5bGVzaGVldCAKICAgIH0KCiAgICBsb2NhdGlvbiAvc3RhdC54c2wgewogICAgICAjIFhNTCBzdHlsZXNoZWV0IHRvIHZpZXcgUlRNUCBzdGF0cy4KICAgICAgcm9vdCAvdXNyL2xvY2FsL25naW54L2h0bWw7CiAgICB9CgogIH0KfQo=
  - path: /etc/rtmp-hls-server/docker-compose.yml
    permissions: '0660'
    encoding: b64
    content: CnZlcnNpb246ICczLjInCnNlcnZpY2VzOgogIHNpbXBsZS1hdXRoOgogICAgaW1hZ2U6IHRoZWNhbGNhaG9saWMvc2ltcGxlLWF1dGgKICAgIHZvbHVtZXM6CiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL3B1Ymxpc2hfc2VjcmV0Oi9ldGMvYXV0aF9jb25maWcvcHVibGlzaC9wYXNzd29yZCIKICAgICAgLSAiL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvcGxheV9zZWNyZXQ6L2V0Yy9hdXRoX2NvbmZpZy9wbGF5L3Bhc3N3b3JkIgogICAgcmVzdGFydDogdW5sZXNzLXN0b3BwZWQKICBydG1wLWhsczoKICAgIGltYWdlOiBhbHF1dGFtaS9ydG1wLWhsczpsYXRlc3QtYWxwaW5lCiAgICBwb3J0czoKICAgICAgLSAiODA6ODAiCiAgICAgIC0gIjQ0Mzo0NDMiCiAgICAgIC0gIjE5MzU6MTkzNSIKICAgIGRlcGVuZHNfb246CiAgICAgIC0gc2ltcGxlLWF1dGgKICAgIHJlc3RhcnQ6IHVubGVzcy1zdG9wcGVkCiAgICB2b2x1bWVzOgogICAgICAtIHR5cGU6IHZvbHVtZQogICAgICAgIHNvdXJjZTogbGV0c2VuY3J5cHQKICAgICAgICB0YXJnZXQ6IC9ldGMvbGV0c2VuY3J5cHQKICAgICAgICByZWFkX29ubHk6IHRydWUKICAgICAgLSAiL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvbmdpbnguY29uZjovZXRjL25naW54L25naW54LmNvbmYiCgp2b2x1bWVzOgogIGxldHNlbmNyeXB0Ogo=

runcmd:
  - 'PUBLiSH_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/password)"'
  - 'PLAY_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/password)"'
  - echo "$PUBLISH_PW" > /etc/rtmp-hls-server/publish_secret
  - echo "$PLAY_PW" > /etc/rtmp-hls-server/play_secret
  - systemctl daemon-reload
  - systemctl start rtmp-hls.service