#cloud-config

  
write_files:
  - path: /etc/systemd/system/rtmp-hls.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      Description=Start the rtmp authentication server

      [Service]
      ExecStart=/usr/bin/docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc/rtmp-hls-server/:/etc/rtmp-hls-server/ -w /etc/rtmp-hls-server/ docker/compose:latest up
      ExecStop=/usr/bin/docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc/rtmp-hls-server/:/etc/rtmp-hls-server/ -w /etc/rtmp-hls-server/ docker/compose:latest down
  - path: /etc/rtmp-hls-server/nginx_no_ssl.conf
    permissions: '0660'
    encoding: b64
    content: CnVzZXIgcm9vdDsKd29ya2VyX3Byb2Nlc3NlcyAgYXV0bzsKd29ya2VyX3JsaW1pdF9ub2ZpbGUgMTAwMDAwOwojZXJyb3JfbG9nICBsb2dzL2Vycm9yLmxvZzsKCmV2ZW50cyB7CiAgd29ya2VyX2Nvbm5lY3Rpb25zICA0MDk2OwogICNlcG9sbDsKfQoKIyBSVE1QIGNvbmZpZ3VyYXRpb24KcnRtcCB7CiAgc2VydmVyIHsKICAgIGxpc3RlbiAxOTM1OyAjIExpc3RlbiBvbiBzdGFuZGFyZCBSVE1QIHBvcnQKICAgIGNodW5rX3NpemUgNDA5NjsgCiAgICBwaW5nIDMwczsKICAgIG5vdGlmeV9tZXRob2QgZ2V0OwoKICAgICMgVGhpcyBhcHBsaWNhdGlvbiBpcyB0byBhY2NlcHQgaW5jb21pbmcgc3RyZWFtCiAgICBhcHBsaWNhdGlvbiBsaXZlIHsKICAgICAgbGl2ZSBvbjsgIyBBbGxvd3MgbGl2ZSBpbnB1dAogICAgICByZWNvcmQgb2ZmOwogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIG9uX3B1Ymxpc2ggaHR0cDovL3NpbXBsZS1hdXRoL3B1Ymxpc2g7CgogICAgICAjIGZvciBlYWNoIHJlY2VpdmVkIHN0cmVhbSwgdHJhbnNjb2RlIGZvciBhZGFwdGl2ZSBzdHJlYW1pbmcKICAgICAgIyBUaGlzIHNpbmdsZSBmZm1wZWcgY29tbWFuZCB0YWtlcyB0aGUgaW5wdXQgYW5kIHRyYW5zZm9ybXMKICAgICAgIyB0aGUgc291cmNlIGludG8gNCBkaWZmZXJlbnQgc3RyZWFtcyB3aXRoIGRpZmZlcmVudCBiaXRyYXRlcwogICAgICAjIGFuZCBxdWFsaXRpZXMuICMgdGhlc2Ugc2V0dGluZ3MgcmVzcGVjdCB0aGUgYXNwZWN0IHJhdGlvLgogICAgICBleGVjX3B1c2ggIC91c3IvbG9jYWwvYmluL2ZmbXBlZyAtaSBydG1wOi8vbG9jYWxob3N0OjE5MzUvJGFwcC8kbmFtZSAtYXN5bmMgMSAtdnN5bmMgLTEKICAgICAgICAgICAgICAgICAgLWM6diBsaWJ4MjY0IC12cHJvZmlsZSBtYWluIC1jOmEgYWFjIC1iOnYgMjU2ayAgLWI6YSA2NGsgIC12ZiAic2NhbGU9NDgwOnRydW5jKG93L2EvMikqMiIgIC10dW5lIHplcm9sYXRlbmN5IC1wcmVzZXQgc3VwZXJmYXN0IC1jcmYgMjMgLWYgZmx2IHJ0bXA6Ly8xMjcuMC4wLjE6MTkzNS9zaG93LyRuYW1lX2xvdwogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLXZwcm9maWxlIG1haW4gLWM6YSBhYWMgLWI6diA3NjhrICAtYjphIDEyOGsgLXZmICJzY2FsZT03MjA6dHJ1bmMob3cvYS8yKSoyIiAgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovLzEyNy4wLjAuMToxOTM1L3Nob3cvJG5hbWVfbWlkCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDEwMjRrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTk2MDp0cnVuYyhvdy9hLzIpKjIiICAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oaWdoCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDE5MjBrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTEyODA6dHJ1bmMob3cvYS8yKSoyIiAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oZDcyMAogICAgICAgICAgICAgICAgICAtYyBjb3B5IC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9zcmM7CiAgICAgIAogICAgICAjcHVibGlzaF9ub3RpZnkgb247CiAgICAgICMgcmVjb3JkX3BhdGggL21udC9yZWNvcmQvOwogICAgICAjIHJlY29yZF91bmlxdWUgb247CiAgICAgICMgcmVjb3JkX2ludGVydmFsIDMwczsKICAgICAgI2V4ZWNfcmVjb3JkX2RvbmUgZmZtcGVnIC15IC1pICRwYXRoIC1hY29kZWMgbGlibXAzbGFtZSAtYXIgNDQxMDAgLWFjIDEgLXZjb2RlYyBsaWJ4MjY0ICRkaXJuYW1lLyRiYXNlbmFtZS5tcDQ7CiAgICAgICNleGVjX3B1Ymxpc2hfZG9uZSAvc2NyaXB0cy9wcm9jZXNzX3JlY29yZGVkLnNoICRkaXJuYW1lICRiYXNlbmFtZTsKICAgICAgI2V4ZWNfcHVibGlzaCAvYmluL2VjaG8gImxpdmUgLyBleGVjX3B1Ymxpc2giID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgICAjIGV4ZWNfcHVibGlzaF9kb25lIGJhc2ggLWMgL3NjcmlwdHMvcHJvY2Vzc19yZWNvcmRlZC5zaCAke25hbWV9OwoKICAgIH0KCiAgICAjIFRoaXMgaXMgdGhlIEhMUyBhcHBsaWNhdGlvbgogICAgYXBwbGljYXRpb24gc2hvdyB7CiAgICAgIGxpdmUgb247ICMgQWxsb3dzIGxpdmUgaW5wdXQgZnJvbSBhYm92ZSBhcHBsaWNhdGlvbgogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIGFsbG93IHB1Ymxpc2ggMTI3LjAuMC4xOwogICAgICBkZW55IHB1Ymxpc2ggYWxsOwogICAgICBkZW55IHBsYXkgYWxsOyAjIGRpc2FibGUgY29uc3VtaW5nIHRoZSBzdHJlYW0gZnJvbSBuZ2lueCBhcyBydG1wCiAgICAgIAogICAgICBobHMgb247ICMgRW5hYmxlIEhUVFAgTGl2ZSBTdHJlYW1pbmcKICAgICAgaGxzX2ZyYWdtZW50IDJzOwogICAgICBobHNfcGxheWxpc3RfbGVuZ3RoIDYwOwogICAgICBobHNfY2xlYW51cCBvbjsKICAgICAgI2hsc19jb250aW51b3VzIG9uOwogICAgICBobHNfcGF0aCAvbW50L2hscy87ICAjIGhscyBmcmFnbWVudHMgcGF0aAogICAgICAjIEluc3RydWN0IGNsaWVudHMgdG8gYWRqdXN0IHJlc29sdXRpb24gYWNjb3JkaW5nIHRvIGJhbmR3aWR0aAogICAgICAjIFZpZGVvSlMgaW5pdGlhbGx5IGFzc3VtZXMgdGhlIGZvbGxvd2luZyBiaXRyYXRlOiA0MTk0MzA0CiAgICAgIGhsc192YXJpYW50IF9zcmMgQkFORFdJRFRIPTQwOTYwMDA7ICMgU291cmNlIGJpdHJhdGUsIHNvdXJjZSByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9oZDcyMCBCQU5EV0lEVEg9MjA0ODAwMDsgIyBIaWdoIGJpdHJhdGUsIEhEIDcyMHAgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfaGlnaCBCQU5EV0lEVEg9MTE1MjAwMDsgIyBIaWdoIGJpdHJhdGUsIGhpZ2hlci10aGFuLVNEIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX21pZCBCQU5EV0lEVEg9NDQ4MDAwOyAjIE1lZGl1bSBiaXRyYXRlLCBTRCByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9sb3cgQkFORFdJRFRIPTI4ODAwMDsgIyBMb3cgYml0cmF0ZSwgc3ViLVNEIHJlc29sdXRpb24KICAgICAgCiAgICAgICMgTVBFRy1EQVNICiAgICAgIGRhc2ggb247CiAgICAgIGRhc2hfcGF0aCAvbW50L2Rhc2gvOyAgIyBkYXNoIGZyYWdtZW50cyBwYXRoCiAgICAgIGRhc2hfZnJhZ21lbnQgMzsKICAgICAgZGFzaF9wbGF5bGlzdF9sZW5ndGggNjA7CQkJCiAgICAgICMgZXhlY19wdWJsaXNoIC9iaW4vZWNobyAic2hvdyAvIGV4ZWNfcHVibGlzaCIgPj4gL3Zhci9sb2cvc2NyaXB0cy5sb2c7CiAgICAgICMgZXhlY19wdWJsaXNoX2RvbmUgL2Jpbi9lY2hvICJzaG93IC8gZXhlY19wdWJsaXNoX2RvbmUiID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgfQogIH0KfQoKCmh0dHAgewogIHNlbmRmaWxlIG9mZjsKICB0Y3Bfbm9wdXNoIG9uOwogIGRpcmVjdGlvIDUxMjsKICAjIGFpbyBvbjsKICBvcGVuX2ZpbGVfY2FjaGUgbWF4PTIwMDAwMCBpbmFjdGl2ZT0yMHM7CiAgb3Blbl9maWxlX2NhY2hlX3ZhbGlkIDMwczsKICBvcGVuX2ZpbGVfY2FjaGVfbWluX3VzZXMgMjsKICBvcGVuX2ZpbGVfY2FjaGVfZXJyb3JzIG9uOwogIGd6aXAgb247CiAgZ3ppcF9taW5fbGVuZ3RoIDEwMjQwOwogIGd6aXBfY29tcF9sZXZlbCAxOwogIGd6aXBfdmFyeSBvbjsKICBnemlwX2Rpc2FibGUgbXNpZTY7CiAgZ3ppcF9wcm94aWVkIGV4cGlyZWQgbm8tY2FjaGUgbm8tc3RvcmUgcHJpdmF0ZSBhdXRoOwogIGd6aXBfdHlwZXMKICAgIHRleHQvY3NzCiAgICB0ZXh0L2phdmFzY3JpcHQKICAgIHRleHQveG1sCiAgICB0ZXh0L3BsYWluCiAgICB0ZXh0L3gtY29tcG9uZW50CiAgICBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0CiAgICBhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQKICAgIGFwcGxpY2F0aW9uL2pzb24KICAgIGFwcGxpY2F0aW9uL3htbAogICAgYXBwbGljYXRpb24vcnNzK3htbAogICAgYXBwbGljYXRpb24vYXRvbSt4bWwKICAgIGZvbnQvdHJ1ZXR5cGUKICAgIGZvbnQvb3BlbnR5cGUKICAgIGFwcGxpY2F0aW9uL3ZuZC5tcy1mb250b2JqZWN0CiAgICBpbWFnZS9zdmcreG1sOwogICNhY2Nlc3NfbG9nIGxvZ3MvYWNjZXNzLmxvZyBtYWluOwogIAogICMgSFRUUCBzZXJ2ZXIgcmVxdWlyZWQgdG8gc2VydmUgdGhlIHBsYXllciBhbmQgSExTIGZyYWdtZW50cwogIHNlcnZlciB7CiAgICAKICAgIGxpc3RlbiA4MDsKICAgIAoKICAgIGxvY2F0aW9uIC8gewogICAgICBhdXRoX2Jhc2ljICJBdXRoZW50aWNhdGlvbiAodXNlcj12aWV3ZXIpIjsKICAgICAgYXV0aF9iYXNpY191c2VyX2ZpbGUgLy5odHBhc3N3ZDsKCiAgICAgIHJvb3QgL2V0Yy9uZ2lueC9odG1sOwogICAgICBpbmRleCBpbmRleC5odG1sIGluZGV4Lmh0bTsKICAgIH0KCiAgICBsb2NhdGlvbiAvbWFuaWZlc3Qud2VibWFuaWZlc3QgewogICAgICBhdXRoX2Jhc2ljIG5vOwogICAgICByb290IC9ldGMvbmdpbngvaHRtbDsKICAgICAgaW5kZXggaW5kZXguaHRtbCBpbmRleC5odG07CiAgICB9CiAgICAjIFNlcnZlIEhMUyBmcmFnbWVudHMKICAgIGxvY2F0aW9uIC9obHMgewogICAgICB0eXBlcyB7CiAgICAgICAgYXBwbGljYXRpb24vdm5kLmFwcGxlLm1wZWd1cmwgbTN1ODsKICAgICAgICB2aWRlby9tcDJ0IHRzOwogICAgICB9CiAgICAgIAogICAgICByb290IC9tbnQ7CgogICAgICBhZGRfaGVhZGVyIENhY2hlLUNvbnRyb2wgbm8tY2FjaGU7ICMgRGlzYWJsZSBjYWNoZQogICAgICAKICAgICAgIyBDT1JTIHNldHVwCiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonIGFsd2F5czsKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtRXhwb3NlLUhlYWRlcnMnICdDb250ZW50LUxlbmd0aCc7CiAgICAgIAogICAgICAjIGFsbG93IENPUlMgcHJlZmxpZ2h0IHJlcXVlc3RzCiAgICAgIGlmICgkcmVxdWVzdF9tZXRob2QgPSAnT1BUSU9OUycpIHsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJzsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1NYXgtQWdlJyAxNzI4MDAwOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtVHlwZScgJ3RleHQvcGxhaW4gY2hhcnNldD1VVEYtOCc7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1MZW5ndGgnIDA7CiAgICAgICAgcmV0dXJuIDIwNDsKICAgICAgfQogICAgfQogICAgCiAgICAjIFNlcnZlIERBU0ggZnJhZ21lbnRzCiAgICBsb2NhdGlvbiAvZGFzaCB7CiAgICAgIHR5cGVzIHsKICAgICAgICBhcHBsaWNhdGlvbi9kYXNoK3htbCBtcGQ7CiAgICAgICAgdmlkZW8vbXA0IG1wNDsKICAgICAgfQoKICAgICAgcm9vdCAvbW50OwogICAgICAKICAgICAgYWRkX2hlYWRlciBDYWNoZS1Db250cm9sIG5vLWNhY2hlOyAjIERpc2FibGUgY2FjaGUKCgogICAgICAjIENPUlMgc2V0dXAKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKicgYWx3YXlzOwogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1FeHBvc2UtSGVhZGVycycgJ0NvbnRlbnQtTGVuZ3RoJzsKCiAgICAgICMgQWxsb3cgQ09SUyBwcmVmbGlnaHQgcmVxdWVzdHMKICAgICAgaWYgKCRyZXF1ZXN0X21ldGhvZCA9ICdPUFRJT05TJykgewogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonOwogICAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLU1heC1BZ2UnIDE3MjgwMDA7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1UeXBlJyAndGV4dC9wbGFpbiBjaGFyc2V0PVVURi04JzsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LUxlbmd0aCcgMDsKICAgICAgICByZXR1cm4gMjA0OwogICAgICB9CiAgICB9CQkKICAgIAogICAgIyBUaGlzIFVSTCBwcm92aWRlcyBSVE1QIHN0YXRpc3RpY3MgaW4gWE1MCiAgICBsb2NhdGlvbiAvc3RhdCB7CiAgICAgIHJ0bXBfc3RhdCBhbGw7CiAgICAgIHJ0bXBfc3RhdF9zdHlsZXNoZWV0IHN0YXQueHNsOyAjIFVzZSBzdGF0LnhzbCBzdHlsZXNoZWV0IAogICAgfQoKICAgIGxvY2F0aW9uIC9zdGF0LnhzbCB7CiAgICAgICMgWE1MIHN0eWxlc2hlZXQgdG8gdmlldyBSVE1QIHN0YXRzLgogICAgICByb290IC91c3IvbG9jYWwvbmdpbngvaHRtbDsKICAgIH0KCiAgfQp9Cg==
  - path: /etc/rtmp-hls-server/nginx_ssl.conf
    permissions: '0660'
    encoding: b64
    content: CnVzZXIgcm9vdDsKd29ya2VyX3Byb2Nlc3NlcyAgYXV0bzsKd29ya2VyX3JsaW1pdF9ub2ZpbGUgMTAwMDAwOwojZXJyb3JfbG9nICBsb2dzL2Vycm9yLmxvZzsKCmV2ZW50cyB7CiAgd29ya2VyX2Nvbm5lY3Rpb25zICA0MDk2OwogICNlcG9sbDsKfQoKIyBSVE1QIGNvbmZpZ3VyYXRpb24KcnRtcCB7CiAgc2VydmVyIHsKICAgIGxpc3RlbiAxOTM1OyAjIExpc3RlbiBvbiBzdGFuZGFyZCBSVE1QIHBvcnQKICAgIGNodW5rX3NpemUgNDA5NjsgCiAgICBwaW5nIDMwczsKICAgIG5vdGlmeV9tZXRob2QgZ2V0OwoKICAgICMgVGhpcyBhcHBsaWNhdGlvbiBpcyB0byBhY2NlcHQgaW5jb21pbmcgc3RyZWFtCiAgICBhcHBsaWNhdGlvbiBsaXZlIHsKICAgICAgbGl2ZSBvbjsgIyBBbGxvd3MgbGl2ZSBpbnB1dAogICAgICByZWNvcmQgb2ZmOwogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIG9uX3B1Ymxpc2ggaHR0cDovL3NpbXBsZS1hdXRoL3B1Ymxpc2g7CgogICAgICAjIGZvciBlYWNoIHJlY2VpdmVkIHN0cmVhbSwgdHJhbnNjb2RlIGZvciBhZGFwdGl2ZSBzdHJlYW1pbmcKICAgICAgIyBUaGlzIHNpbmdsZSBmZm1wZWcgY29tbWFuZCB0YWtlcyB0aGUgaW5wdXQgYW5kIHRyYW5zZm9ybXMKICAgICAgIyB0aGUgc291cmNlIGludG8gNCBkaWZmZXJlbnQgc3RyZWFtcyB3aXRoIGRpZmZlcmVudCBiaXRyYXRlcwogICAgICAjIGFuZCBxdWFsaXRpZXMuICMgdGhlc2Ugc2V0dGluZ3MgcmVzcGVjdCB0aGUgYXNwZWN0IHJhdGlvLgogICAgICBleGVjX3B1c2ggIC91c3IvbG9jYWwvYmluL2ZmbXBlZyAtaSBydG1wOi8vbG9jYWxob3N0OjE5MzUvJGFwcC8kbmFtZSAtYXN5bmMgMSAtdnN5bmMgLTEKICAgICAgICAgICAgICAgICAgLWM6diBsaWJ4MjY0IC12cHJvZmlsZSBtYWluIC1jOmEgYWFjIC1iOnYgMjU2ayAgLWI6YSA2NGsgIC12ZiAic2NhbGU9NDgwOnRydW5jKG93L2EvMikqMiIgIC10dW5lIHplcm9sYXRlbmN5IC1wcmVzZXQgc3VwZXJmYXN0IC1jcmYgMjMgLWYgZmx2IHJ0bXA6Ly8xMjcuMC4wLjE6MTkzNS9zaG93LyRuYW1lX2xvdwogICAgICAgICAgICAgICAgICAtYzp2IGxpYngyNjQgLXZwcm9maWxlIG1haW4gLWM6YSBhYWMgLWI6diA3NjhrICAtYjphIDEyOGsgLXZmICJzY2FsZT03MjA6dHJ1bmMob3cvYS8yKSoyIiAgLXR1bmUgemVyb2xhdGVuY3kgLXByZXNldCBzdXBlcmZhc3QgLWNyZiAyMyAtZiBmbHYgcnRtcDovLzEyNy4wLjAuMToxOTM1L3Nob3cvJG5hbWVfbWlkCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDEwMjRrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTk2MDp0cnVuYyhvdy9hLzIpKjIiICAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oaWdoCiAgICAgICAgICAgICAgICAgIC1jOnYgbGlieDI2NCAtdnByb2ZpbGUgbWFpbiAtYzphIGFhYyAtYjp2IDE5MjBrIC1iOmEgMTI4ayAtdmYgInNjYWxlPTEyODA6dHJ1bmMob3cvYS8yKSoyIiAtdHVuZSB6ZXJvbGF0ZW5jeSAtcHJlc2V0IHN1cGVyZmFzdCAtY3JmIDIzIC1mIGZsdiBydG1wOi8vMTI3LjAuMC4xOjE5MzUvc2hvdy8kbmFtZV9oZDcyMAogICAgICAgICAgICAgICAgICAtYyBjb3B5IC1mIGZsdiBydG1wOi8vbG9jYWxob3N0OjE5MzUvc2hvdy8kbmFtZV9zcmM7CiAgICAgIAogICAgICAjcHVibGlzaF9ub3RpZnkgb247CiAgICAgICMgcmVjb3JkX3BhdGggL21udC9yZWNvcmQvOwogICAgICAjIHJlY29yZF91bmlxdWUgb247CiAgICAgICMgcmVjb3JkX2ludGVydmFsIDMwczsKICAgICAgI2V4ZWNfcmVjb3JkX2RvbmUgZmZtcGVnIC15IC1pICRwYXRoIC1hY29kZWMgbGlibXAzbGFtZSAtYXIgNDQxMDAgLWFjIDEgLXZjb2RlYyBsaWJ4MjY0ICRkaXJuYW1lLyRiYXNlbmFtZS5tcDQ7CiAgICAgICNleGVjX3B1Ymxpc2hfZG9uZSAvc2NyaXB0cy9wcm9jZXNzX3JlY29yZGVkLnNoICRkaXJuYW1lICRiYXNlbmFtZTsKICAgICAgI2V4ZWNfcHVibGlzaCAvYmluL2VjaG8gImxpdmUgLyBleGVjX3B1Ymxpc2giID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgICAjIGV4ZWNfcHVibGlzaF9kb25lIGJhc2ggLWMgL3NjcmlwdHMvcHJvY2Vzc19yZWNvcmRlZC5zaCAke25hbWV9OwoKICAgIH0KCiAgICAjIFRoaXMgaXMgdGhlIEhMUyBhcHBsaWNhdGlvbgogICAgYXBwbGljYXRpb24gc2hvdyB7CiAgICAgIGxpdmUgb247ICMgQWxsb3dzIGxpdmUgaW5wdXQgZnJvbSBhYm92ZSBhcHBsaWNhdGlvbgogICAgICBwbGF5X3Jlc3RhcnQgb247CiAgICAgIGFsbG93IHB1Ymxpc2ggMTI3LjAuMC4xOwogICAgICBkZW55IHB1Ymxpc2ggYWxsOwogICAgICBkZW55IHBsYXkgYWxsOyAjIGRpc2FibGUgY29uc3VtaW5nIHRoZSBzdHJlYW0gZnJvbSBuZ2lueCBhcyBydG1wCiAgICAgIAogICAgICBobHMgb247ICMgRW5hYmxlIEhUVFAgTGl2ZSBTdHJlYW1pbmcKICAgICAgaGxzX2ZyYWdtZW50IDJzOwogICAgICBobHNfcGxheWxpc3RfbGVuZ3RoIDYwOwogICAgICBobHNfY2xlYW51cCBvbjsKICAgICAgI2hsc19jb250aW51b3VzIG9uOwogICAgICBobHNfcGF0aCAvbW50L2hscy87ICAjIGhscyBmcmFnbWVudHMgcGF0aAogICAgICAjIEluc3RydWN0IGNsaWVudHMgdG8gYWRqdXN0IHJlc29sdXRpb24gYWNjb3JkaW5nIHRvIGJhbmR3aWR0aAogICAgICAjIFZpZGVvSlMgaW5pdGlhbGx5IGFzc3VtZXMgdGhlIGZvbGxvd2luZyBiaXRyYXRlOiA0MTk0MzA0CiAgICAgIGhsc192YXJpYW50IF9zcmMgQkFORFdJRFRIPTQwOTYwMDA7ICMgU291cmNlIGJpdHJhdGUsIHNvdXJjZSByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9oZDcyMCBCQU5EV0lEVEg9MjA0ODAwMDsgIyBIaWdoIGJpdHJhdGUsIEhEIDcyMHAgcmVzb2x1dGlvbgogICAgICBobHNfdmFyaWFudCBfaGlnaCBCQU5EV0lEVEg9MTE1MjAwMDsgIyBIaWdoIGJpdHJhdGUsIGhpZ2hlci10aGFuLVNEIHJlc29sdXRpb24KICAgICAgaGxzX3ZhcmlhbnQgX21pZCBCQU5EV0lEVEg9NDQ4MDAwOyAjIE1lZGl1bSBiaXRyYXRlLCBTRCByZXNvbHV0aW9uCiAgICAgIGhsc192YXJpYW50IF9sb3cgQkFORFdJRFRIPTI4ODAwMDsgIyBMb3cgYml0cmF0ZSwgc3ViLVNEIHJlc29sdXRpb24KICAgICAgCiAgICAgICMgTVBFRy1EQVNICiAgICAgIGRhc2ggb247CiAgICAgIGRhc2hfcGF0aCAvbW50L2Rhc2gvOyAgIyBkYXNoIGZyYWdtZW50cyBwYXRoCiAgICAgIGRhc2hfZnJhZ21lbnQgMzsKICAgICAgZGFzaF9wbGF5bGlzdF9sZW5ndGggNjA7CQkJCiAgICAgICMgZXhlY19wdWJsaXNoIC9iaW4vZWNobyAic2hvdyAvIGV4ZWNfcHVibGlzaCIgPj4gL3Zhci9sb2cvc2NyaXB0cy5sb2c7CiAgICAgICMgZXhlY19wdWJsaXNoX2RvbmUgL2Jpbi9lY2hvICJzaG93IC8gZXhlY19wdWJsaXNoX2RvbmUiID4+IC92YXIvbG9nL3NjcmlwdHMubG9nOwogICAgfQogIH0KfQoKCmh0dHAgewogIHNlbmRmaWxlIG9mZjsKICB0Y3Bfbm9wdXNoIG9uOwogIGRpcmVjdGlvIDUxMjsKICAjIGFpbyBvbjsKICBvcGVuX2ZpbGVfY2FjaGUgbWF4PTIwMDAwMCBpbmFjdGl2ZT0yMHM7CiAgb3Blbl9maWxlX2NhY2hlX3ZhbGlkIDMwczsKICBvcGVuX2ZpbGVfY2FjaGVfbWluX3VzZXMgMjsKICBvcGVuX2ZpbGVfY2FjaGVfZXJyb3JzIG9uOwogIGd6aXAgb247CiAgZ3ppcF9taW5fbGVuZ3RoIDEwMjQwOwogIGd6aXBfY29tcF9sZXZlbCAxOwogIGd6aXBfdmFyeSBvbjsKICBnemlwX2Rpc2FibGUgbXNpZTY7CiAgZ3ppcF9wcm94aWVkIGV4cGlyZWQgbm8tY2FjaGUgbm8tc3RvcmUgcHJpdmF0ZSBhdXRoOwogIGd6aXBfdHlwZXMKICAgIHRleHQvY3NzCiAgICB0ZXh0L2phdmFzY3JpcHQKICAgIHRleHQveG1sCiAgICB0ZXh0L3BsYWluCiAgICB0ZXh0L3gtY29tcG9uZW50CiAgICBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0CiAgICBhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQKICAgIGFwcGxpY2F0aW9uL2pzb24KICAgIGFwcGxpY2F0aW9uL3htbAogICAgYXBwbGljYXRpb24vcnNzK3htbAogICAgYXBwbGljYXRpb24vYXRvbSt4bWwKICAgIGZvbnQvdHJ1ZXR5cGUKICAgIGZvbnQvb3BlbnR5cGUKICAgIGFwcGxpY2F0aW9uL3ZuZC5tcy1mb250b2JqZWN0CiAgICBpbWFnZS9zdmcreG1sOwogICNhY2Nlc3NfbG9nIGxvZ3MvYWNjZXNzLmxvZyBtYWluOwogIAogICMgSFRUUCBzZXJ2ZXIgcmVxdWlyZWQgdG8gc2VydmUgdGhlIHBsYXllciBhbmQgSExTIGZyYWdtZW50cwogIHNlcnZlciB7CiAgICAKICAgIGxpc3RlbiA0NDM7CiAgICAKICAgIHNlcnZlcl9uYW1lIFtbU0VSVkVSX05BTUVdXTsKICAgIHNzbCBvbjsKICAgIHNzbF9jZXJ0aWZpY2F0ZSAvbW50L2xldHNlbmNyeXB0L2xpdmUvW1tTRVJWRVJfTkFNRV1dL2Z1bGxjaGFpbi5wZW07CiAgICBzc2xfY2VydGlmaWNhdGVfa2V5IC9tbnQvbGV0c2VuY3J5cHQvbGl2ZS9bW1NFUlZFUl9OQU1FXV0vcHJpdmtleS5wZW07CiAgICAKCiAgICBsb2NhdGlvbiAvIHsKICAgICAgYXV0aF9iYXNpYyAiQXV0aGVudGljYXRpb24gKHVzZXI9dmlld2VyKSI7CiAgICAgIGF1dGhfYmFzaWNfdXNlcl9maWxlIC8uaHRwYXNzd2Q7CgogICAgICByb290IC9ldGMvbmdpbngvaHRtbDsKICAgICAgaW5kZXggaW5kZXguaHRtbCBpbmRleC5odG07CiAgICB9CgogICAgbG9jYXRpb24gL21hbmlmZXN0LndlYm1hbmlmZXN0IHsKICAgICAgYXV0aF9iYXNpYyBubzsKICAgICAgcm9vdCAvZXRjL25naW54L2h0bWw7CiAgICAgIGluZGV4IGluZGV4Lmh0bWwgaW5kZXguaHRtOwogICAgfQogICAgIyBTZXJ2ZSBITFMgZnJhZ21lbnRzCiAgICBsb2NhdGlvbiAvaGxzIHsKICAgICAgdHlwZXMgewogICAgICAgIGFwcGxpY2F0aW9uL3ZuZC5hcHBsZS5tcGVndXJsIG0zdTg7CiAgICAgICAgdmlkZW8vbXAydCB0czsKICAgICAgfQogICAgICAKICAgICAgcm9vdCAvbW50OwoKICAgICAgYWRkX2hlYWRlciBDYWNoZS1Db250cm9sIG5vLWNhY2hlOyAjIERpc2FibGUgY2FjaGUKICAgICAgCiAgICAgICMgQ09SUyBzZXR1cAogICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJyBhbHdheXM7CiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUV4cG9zZS1IZWFkZXJzJyAnQ29udGVudC1MZW5ndGgnOwogICAgICAKICAgICAgIyBhbGxvdyBDT1JTIHByZWZsaWdodCByZXF1ZXN0cwogICAgICBpZiAoJHJlcXVlc3RfbWV0aG9kID0gJ09QVElPTlMnKSB7CiAgICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJyAnKic7CiAgICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtTWF4LUFnZScgMTcyODAwMDsKICAgICAgICBhZGRfaGVhZGVyICdDb250ZW50LVR5cGUnICd0ZXh0L3BsYWluIGNoYXJzZXQ9VVRGLTgnOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtTGVuZ3RoJyAwOwogICAgICAgIHJldHVybiAyMDQ7CiAgICAgIH0KICAgIH0KICAgIAogICAgIyBTZXJ2ZSBEQVNIIGZyYWdtZW50cwogICAgbG9jYXRpb24gL2Rhc2ggewogICAgICB0eXBlcyB7CiAgICAgICAgYXBwbGljYXRpb24vZGFzaCt4bWwgbXBkOwogICAgICAgIHZpZGVvL21wNCBtcDQ7CiAgICAgIH0KCiAgICAgIHJvb3QgL21udDsKICAgICAgCiAgICAgIGFkZF9oZWFkZXIgQ2FjaGUtQ29udHJvbCBuby1jYWNoZTsgIyBEaXNhYmxlIGNhY2hlCgoKICAgICAgIyBDT1JTIHNldHVwCiAgICAgIGFkZF9oZWFkZXIgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicgJyonIGFsd2F5czsKICAgICAgYWRkX2hlYWRlciAnQWNjZXNzLUNvbnRyb2wtRXhwb3NlLUhlYWRlcnMnICdDb250ZW50LUxlbmd0aCc7CgogICAgICAjIEFsbG93IENPUlMgcHJlZmxpZ2h0IHJlcXVlc3RzCiAgICAgIGlmICgkcmVxdWVzdF9tZXRob2QgPSAnT1BUSU9OUycpIHsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nICcqJzsKICAgICAgICBhZGRfaGVhZGVyICdBY2Nlc3MtQ29udHJvbC1NYXgtQWdlJyAxNzI4MDAwOwogICAgICAgIGFkZF9oZWFkZXIgJ0NvbnRlbnQtVHlwZScgJ3RleHQvcGxhaW4gY2hhcnNldD1VVEYtOCc7CiAgICAgICAgYWRkX2hlYWRlciAnQ29udGVudC1MZW5ndGgnIDA7CiAgICAgICAgcmV0dXJuIDIwNDsKICAgICAgfQogICAgfQkJCiAgICAKICAgICMgVGhpcyBVUkwgcHJvdmlkZXMgUlRNUCBzdGF0aXN0aWNzIGluIFhNTAogICAgbG9jYXRpb24gL3N0YXQgewogICAgICBydG1wX3N0YXQgYWxsOwogICAgICBydG1wX3N0YXRfc3R5bGVzaGVldCBzdGF0LnhzbDsgIyBVc2Ugc3RhdC54c2wgc3R5bGVzaGVldCAKICAgIH0KCiAgICBsb2NhdGlvbiAvc3RhdC54c2wgewogICAgICAjIFhNTCBzdHlsZXNoZWV0IHRvIHZpZXcgUlRNUCBzdGF0cy4KICAgICAgcm9vdCAvdXNyL2xvY2FsL25naW54L2h0bWw7CiAgICB9CgogIH0KfQo=
  - path: /etc/rtmp-hls-server/docker-compose.yml
    permissions: '0660'
    encoding: b64
    content: CnZlcnNpb246ICczLjInCnNlcnZpY2VzOgogIHNpbXBsZS1hdXRoOgogICAgaW1hZ2U6IHRoZWNhbGNhaG9saWMvc2ltcGxlLWF1dGgKICAgIHZvbHVtZXM6CiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL2F1dGhfY29uZmlnOi9ldGMvYXV0aF9jb25maWciCiAgICByZXN0YXJ0OiB1bmxlc3Mtc3RvcHBlZAogIHJ0bXAtaGxzOgogICAgaW1hZ2U6IGFscXV0YW1pL3J0bXAtaGxzOmxhdGVzdC1hbHBpbmUKICAgIHBvcnRzOgogICAgICAtICI4MDo4MCIKICAgICAgLSAiNDQzOjQ0MyIKICAgICAgLSAiMTkzNToxOTM1IgogICAgZGVwZW5kc19vbjoKICAgICAgLSBzaW1wbGUtYXV0aAogICAgcmVzdGFydDogdW5sZXNzLXN0b3BwZWQKICAgIHZvbHVtZXM6CiAgICAgIC0gdHlwZTogdm9sdW1lCiAgICAgICAgc291cmNlOiBsZXRzZW5jcnlwdAogICAgICAgIHRhcmdldDogL2V0Yy9sZXRzZW5jcnlwdAogICAgICAgIHJlYWRfb25seTogdHJ1ZQogICAgICAtICIvZXRjL3J0bXAtaGxzLXNlcnZlci9uZ2lueC5jb25mOi9ldGMvbmdpbngvbmdpbnguY29uZiIKICAgICAgLSAiL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvcGxheWVyOi9ldGMvbmdpbngvaHRtbC8iCiAgICAgIC0gdHlwZTogYmluZAogICAgICAgIHNvdXJjZTogL2V0Yy9ydG1wLWhscy1zZXJ2ZXIvLmh0cGFzc3dkCiAgICAgICAgdGFyZ2V0OiAvLmh0cGFzc3dkCiAgICAgIC0gIi9tbnQvZGlza3MvZGF0YS86L21udC8iCiAgICAgIC0gIi9ldGMvcnRtcC1obHMtc2VydmVyL3NjcmlwdHM6L3NjcmlwdHMiCgoKdm9sdW1lczoKICBsZXRzZW5jcnlwdDoK
  - path: /etc/rtmp-hls-server/player/index.html
    permissions: '0660'
    encoding: b64
    content: CjwhRE9DVFlQRSBodG1sPgo8aHRtbD4KICA8aGVhZD4KICAgIDx0aXRsZT5MaXZlIFN0cmVhbTwvdGl0bGU+CiAgICA8bWV0YSBjaGFyc2V0PSJVVEYtOCI+CiAgICA8bGluayByZWw9Im1hbmlmZXN0IiBocmVmPSJtYW5pZmVzdC53ZWJtYW5pZmVzdCI+CiAgICA8bGluawogICAgICBocmVmPSJodHRwczovL3VucGtnLmNvbS92aWRlby5qc0A3L2Rpc3QvdmlkZW8tanMubWluLmNzcyIKICAgICAgcmVsPSJzdHlsZXNoZWV0IgogICAgLz4KCiAgICA8IS0tIENpdHkgLS0+CiAgICA8IS0tIDxsaW5rIGhyZWY9Imh0dHBzOi8vdW5wa2cuY29tL0B2aWRlb2pzL3RoZW1lc0AxL2Rpc3QvY2l0eS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+IC0tPgogICAgCiAgICA8IS0tIEZhbnRhc3kgLS0+CiAgICA8IS0tIDxsaW5rIGhyZWY9Imh0dHBzOi8vdW5wa2cuY29tL0B2aWRlb2pzL3RoZW1lc0AxL2Rpc3QvZmFudGFzeS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+IC0tPgogICAgCiAgICA8IS0tIEZvcmVzdCAtLT4KICAgIDwhLS0gPGxpbmsgaHJlZj0iaHR0cHM6Ly91bnBrZy5jb20vQHZpZGVvanMvdGhlbWVzQDEvZGlzdC9mb3Jlc3QvaW5kZXguY3NzIiByZWw9InN0eWxlc2hlZXQiPiAtLT4KICAgIAogICAgPCEtLSBTZWEgLS0+CiAgICA8bGluayBocmVmPSJodHRwczovL3VucGtnLmNvbS9AdmlkZW9qcy90aGVtZXNAMS9kaXN0L3NlYS9pbmRleC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+CiAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogICAgICAjc3RyZWFtIHsKICAgICAgICBtYXJnaW46IGF1dG87CiAgICAgIH0KICAgICAgaDEgewogICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgICAgfQogICAgICAjZmlyZWZveC1hbmRyb2lkLXdhcm5pbmcgewogICAgICAgIGJvcmRlci1zdHlsZTogZGFzaGVkOwogICAgICAgIGJvcmRlci1jb2xvcjogcmVkOwogICAgICAgIGJvcmRlci13aWR0aDogMnB4OwogICAgICAgIGZvbnQtc2l6ZTogMS40ZW07CiAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgICAgIHBhZGRpbmc6IDFlbTsKICAgICAgfQoKICAgICAgLmhpZGRlbiB7CiAgICAgICAgZGlzcGxheTogbm9uZTsKICAgICAgfQoKICAgICAgI2RlYnVnLW91dHB1dCB7CiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogIzA1MDUwNTsKICAgICAgICBjb2xvcjogd2hpdGU7CiAgICAgICAgdGV4dC1hbGlnbjogbGVmdDsKICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgICAgIHBhZGRpbmc6IDJlbTsKICAgICAgICBwYWRkaW5nLWxlZnQ6IDRlbTsKICAgICAgICBtYXJnaW4tdG9wOiA0ZW07CiAgICAgICAgbWluLXdpZHRoOiA1MCU7CiAgICAgIH0KICAgICAgI2RlYnVnLW91dHB1dDpub3QoLmhpZGRlbikgewogICAgICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgICAgfQogICAgPC9zdHlsZT4KICA8L2hlYWQ+CiAgPGJvZHk+CiAgICA8ZGl2IHN0eWxlPSJkaXNwbGF5OiBibG9jazsgdGV4dC1hbGlnbjogY2VudGVyOyI+CiAgICAgIDxoMT5Ib2NoemVpdHMtU3RyZWFtIEphbmEgJiBTaW1vbiBIZWnDn3dvbGY8L2gxPgogICAgICA8dmlkZW8gCiAgICAgICAgaWQ9J3N0cmVhbScgCiAgICAgICAgY2xhc3M9J3ZpZGVvLWpzIHZqcy10aGVtZS1zZWEnIAogICAgICAgIHdpZHRoPSc3MjAnCiAgICAgICAgaGVpZ2h0PSc0ODAnIAogICAgICAgIHByZWxvYWQ9YXV0byAKICAgICAgICBjb250cm9scz4KICAgICAgICA8c291cmNlCiAgICAgICAgICBzcmM9Ii9obHMvaG9zaWphLm0zdTgiCiAgICAgICAgICB0eXBlPSJhcHBsaWNhdGlvbi94LW1wZWdVUkwiPgogICAgICAgIAogICAgICAgIDxzb3VyY2UKICAgICAgICAgIHNyYz0iL2Rhc2gvaG9zaWphX3NyYy5tcGQiCiAgICAgICAgICB0eXBlPSJhcHBsaWNhdGlvbi9kYXNoK3htbCI+CiAgICAgICAgPHAgY2xhc3M9InZqcy1uby1qcyI+CiAgICAgICAgICBUbyB2aWV3IHRoaXMgdmlkZW8gcGxlYXNlIGVuYWJsZSBKYXZhU2NyaXB0LCBhbmQgY29uc2lkZXIgdXBncmFkaW5nIHRvIGEgd2ViIGJyb3dzZXIgdGhhdAogICAgICAgICAgPGEgaHJlZj0iaHR0cHM6Ly92aWRlb2pzLmNvbS9odG1sNS12aWRlby1zdXBwb3J0LyIgdGFyZ2V0PSJfYmxhbmsiPnN1cHBvcnRzIEhUTUw1IHZpZGVvPC9hPgogICAgICAgIDwvcD4KICAgICAgPC92aWRlbz4KICAgICAgPGRpdiBpZD0iZmlyZWZveC1hbmRyb2lkLXdhcm5pbmciIGNsYXNzPSJoaWRkZW4iPgogICAgICAgIEJpdHRlIG51dHplIGRlbiBDaHJvbWUtQnJvd3NlciwgdW0gZWluZSBmZWhsZXJmcmVpZSBXaWVkZXJnYWJlIHp1IGdld8OkaHJsZWlzdGVuLgogICAgICA8L2Rpdj4KICAgICAgPG9sIGlkPSJkZWJ1Zy1vdXRwdXQiIGNsYXNzPSJoaWRkZW4iPgogICAgICAgIDxsaT4jIGRlYnVnIG91dHB1dDo8L2xpPgogICAgICA8L29sPgogICAgPC9kaXY+CiAgICAKICAgIDxzY3JpcHQgc3JjPSJodHRwczovL3Zqcy56ZW5jZG4ubmV0LzcuMC4wL3ZpZGVvLm1pbi5qcyIgdHlwZT0iYXBwbGljYXRpb24vamF2YXNjcmlwdCI+PC9zY3JpcHQ+CiAgICA8c2NyaXB0PgogICAgICB3aW5kb3cuSEVMUF9JTVBST1ZFX1ZJREVPSlMgPSBmYWxzZTsKICAgICAgd2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoKICAgICAgICBsZXQgZGF0YVNldHVwID0gewogICAgICAgICAgaHRtbDU6IHsKICAgICAgICAgICAgVm9sdW1lTWVudUJ1dHRvbjogdHJ1ZSwKICAgICAgICAgICAgbmF0aXZlQXVkaW9UcmFja3M6IGZhbHNlLAogICAgICAgICAgICBuYXRpdmVWaWRlb1RyYWNrczogZmFsc2UsCiAgICAgICAgICAgIGhsczogewogICAgICAgICAgICAgIG92ZXJyaWRlTmF0aXZlOiB0cnVlLAogICAgICAgICAgICAgIGVuYWJsZUxvd0luaXRpYWxQbGF5bGlzdDogdHJ1ZSwKICAgICAgICAgICAgICBzbW9vdGhRdWFsaXR5Q2hhbmdlOiB0cnVlLAogICAgICAgICAgICAgIGJhbmR3aWR0aDogMAogICAgICAgICAgICB9LAogICAgICAgICAgICBkYXNoOiB7CiAgICAgICAgICAgICAgb3ZlcnJpZGVOYXRpdmU6IHRydWUsCiAgICAgICAgICAgICAgZW5hYmxlTG93SW5pdGlhbFBsYXlsaXN0OiB0cnVlLAogICAgICAgICAgICAgIHNtb290aFF1YWxpdHlDaGFuZ2U6IHRydWUsCiAgICAgICAgICAgICAgYmFuZHdpZHRoOiAwCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGxldCB2cGxheWVyID0gdmlkZW9qcygnc3RyZWFtJywgZGF0YVNldHVwKTsKCiAgICAgICAgaWYgKCB3aW5kb3cubG9jYXRpb24uc2VhcmNoLnN1YnN0cigxKS5pbmRleE9mKCJkZWJ1Zz0xIikgIT0gLTEgKSB7CiAgICAgICAgICBsZXQgY29uc29sZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNkZWJ1Zy1vdXRwdXQnKTsKICAgICAgICAgIGNvbnNvbGUuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJyk7CiAgICAgICAgICBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHZwbGF5ZXIgPT0gbnVsbCApCiAgICAgICAgICAgICAgdnBsYXllciA9IHZpZGVvanMuZ2V0UGxheWVyKCdzdHJlYW0nKTsKICAgICAgICAgICAgbGV0IGxpbmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogICAgICAgICAgICBsZXQgdGVjaCA9IHZwbGF5ZXIudGVjaCh7SVdpbGxOb3RVc2VUaGlzSW5QbHVnaW5zOiB0cnVlfSk7CiAgICAgICAgICAgIGxpbmUuaW5uZXJUZXh0ID0gYGN1cnJlbnQgYmFuZHdpZHRoOiAke3RlY2guaGxzLmJhbmR3aWR0aH07IGAgCiAgICAgICAgICAgICAgKyBgY3VycmVudCBzb3VyY2U6ICR7dGVjaC5jdXJyZW50U291cmNlXy5zcmN9OyBgIAogICAgICAgICAgICAgICsgYGN1cnJlbnQgcGxheWxpc3Q6ICR7dGVjaC5obHMucGxheWxpc3RzLm1lZGlhXy51cml9YDsKICAgICAgICAgICAgY29uc29sZS5hcHBlbmRDaGlsZChsaW5lKTsKICAgICAgICAgIH0sIDEwMDAwKTsKICAgICAgICB9CiAgICAgIH07CiAgICA8L3NjcmlwdD4KICA8L2JvZHk+CjwvaHRtbD4K
  - path: /etc/rtmp-hls-server/player/manifest.webmanifest
    permissions: '0660'
    encoding: b64
    content: CnsKICAic2hvcnRfbmFtZSI6ICJ3ZWRkaW5nLWxpdmUtc3RyZWFtIiwgCiAgIm5hbWUiOiAiSG9jaHplaXRzLUxpdmVzdHJlYW0gdm9uIEphbmEgJiBTaW1vbiBIZWnDn3dvbGYiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAgICAgICJtaW5pbWFsLXVpIiwKICAib3JpZW50YXRpb24iOiAgImxhbmRzY2FwZSIKfQo=
  - path: /etc/rtmp-hls-server/.htpasswd
    permissions: '0660'
    content: "viewer:$apr1$iSGnjknG$vMVE.YBE1xydDU4sFX2WI1"
  - path: /etc/rtmp-hls-server/scripts/process_recorded.sh
    permissions: '0775'
    encoding: b64
    content: CiMhL3Vzci9iaW4vZW52IGJhc2gKCmVjaG8gIlN0YXJ0aW5nIHNjcmlwdC4uLiIgfCB0ZWUgLWEgL3RtcC9zY3JpcHQubG9nCmVjaG8gJEAgfCB0ZWUgLWEgL3RtcC9zY3JpcHQubG9nCkRJUk5BTUU9IiR7MT99IgpCQVNFTkFNRT0iJHsyP30iCgp7CiAgc2V0IC1ldQogIGVjaG8gIkV4ZWN1dGluZy4uLiBmZm1wZWcgLWYgY29uY2F0IC1zYWZlIDAgLWkgPChmb3IgZiBpbiBcJChscyAtMSAvbW50L3JlY29yZC9cKi5mbHYpOyBkbyBlY2hvIFwiZmlsZSAnXCRmJ1wiOyBkb25lKSAtYyBjb3B5ICRESVJOQU1FLyRCQVNFTkFNRS5tcDQiCiAgZmZtcGVnIC1mIGNvbmNhdCAtc2FmZSAwIC1pIDwoZm9yIGYgaW4gJChscyAtMSAkRElSTkFNRS8qLmZsdik7IGRvIGVjaG8gImZpbGUgJyRmJyI7IGRvbmUpIC1jIGNvcHkgJERJUk5BTUUvJEJBU0VOQU1FLm1wNAp9IDI+JjEgfCB0ZWUgLWEgL3RtcC9zY3JpcHQubG9nCg==

runcmd:
  - set -x
  - systemctl stop rtmp-hls.service || true
  - 'ATTRIBUTES="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/)"'
  - PUBLISH_PW=""
  - PLAY_PW=""
  - |
    if echo "$ATTRIBUTES" | grep 'publish-password' > /dev/null
    then
      PUBLISH_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/publish-password)"
    fi
  - |
    if echo $ATTRIBUTES | grep 'play-password' > /dev/null
    then
      PLAY_PW="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/play-password)"
    fi
  - mkdir -p /etc/rtmp-hls-server/auth_config/publish /etc/rtmp-hls-server/auth_config/play
  - echo "$PUBLISH_PW" | tee /etc/rtmp-hls-server/auth_config/publish/password
  - echo "$PLAY_PW" > /etc/rtmp-hls-server/auth_config/play/password
  - systemctl daemon-reload
  - |
    if echo "$ATTRIBUTES" | grep 'ssl-domain' > /dev/null && echo "$ATTRIBUTES" | grep 'ssl-email' > /dev/null
    then
      LETSENCRYPT_EMAIL="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/ssl-email)"
      LETSENCRYPT_DOMAIN="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/attributes/ssl-domain)"
      
      docker run --rm --name certbot -v "/mnt/disks/data/letsencrypt:/etc/letsencrypt" -p 80:80 -p 443:443 certbot/certbot \
      certonly --agree-tos --standalone -m $LETSENCRYPT_EMAIL -d $LETSENCRYPT_DOMAIN || echo "Certificate does exist and is valid. Nothing to do..."
      sed -i "s/\[\[SERVER_NAME\]\]/$LETSENCRYPT_DOMAIN/g" /etc/rtmp-hls-server/nginx_ssl.conf
      cp /etc/rtmp-hls-server/nginx_ssl.conf /etc/rtmp-hls-server/nginx.conf
    else
      cp /etc/rtmp-hls-server/nginx_no_ssl.conf /etc/rtmp-hls-server/nginx.conf
    fi
  - systemctl start rtmp-hls.service
  - while [[ -z "$(docker ps --filter "name=rtmp-hls-server_rtmp-hls_1" --filter "status=running" --format "{{.ID}}" 2> /dev/null )" ]]; do sleep 3; done
  - docker exec rtmp-hls-server_rtmp-hls_1 bash -c "mkdir -p /mnt/record"

bootcmd:
  - rm -r /etc/rtmp-hls-server
  - mkdir -p /mnt/disks/data
  - |
    mount -o discard,defaults /dev/disk/by-id/scsi-0Google_PersistentDisk_data /mnt/disks/data || {
      echo "data disk not formatted! Formatting now..."
      mkfs.ext4 /dev/disk/by-id/scsi-0Google_PersistentDisk_data
      mount -o discard,defaults /dev/disk/by-id/scsi-0Google_PersistentDisk_data /mnt/disks/data
    }
  